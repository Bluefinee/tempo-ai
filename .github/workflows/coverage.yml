name: Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches:
      - main
      - develop
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_call:
    inputs:
      coverage-percent:
        description: 'Coverage percentage from backend'
        required: false
        type: string
        default: '0'

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  coverage:
    name: ðŸ“Š Coverage Report & Comment
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' || github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: "./backend/pnpm-lock.yaml"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate test coverage
        run: pnpm run test:coverage

      - name: Create coverage badge and metrics
        id: coverage
        run: |
          COVERAGE_JSON=./coverage/coverage-summary.json
          node -e "
            const summary = JSON.parse(require('fs').readFileSync('${COVERAGE_JSON}', 'utf8')).total;
            const pick = (k) => Number(summary[k]?.pct ?? 0).toFixed(2);
            const out = {
              statements: pick('statements'),
              branches: pick('branches'),
              functions: pick('functions'),
              lines: pick('lines'),
            };
            const badgeColor = out.lines >= 80 ? 'brightgreen' : out.lines >= 60 ? 'yellow' : 'red';
            console.log(`COVERAGE_BADGE_URL=https://img.shields.io/badge/coverage-${out.lines}%25-${badgeColor}`);
            for (const [k,v] of Object.entries(out)) {
              console.log(`${k.toUpperCase()}=${v}`);
            }
          " >> "$GITHUB_ENV"

      - name: Create coverage summary page
        if: github.event_name == 'push' || github.event_name == 'workflow_run'
        run: |
          mkdir -p ./public
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
          if [ "${LINES}" -ge 80 ]; then
            STATUS_EMOJI="âœ…"
            STATUS_COLOR="#28a745"
          elif [ "${LINES}" -ge 60 ]; then
            STATUS_EMOJI="âš ï¸"
            STATUS_COLOR="#ffa500"
          else
            STATUS_EMOJI="âŒ"
            STATUS_COLOR="#dc3545"
          fi
          cat > ./public/index.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Tempo AI - Test Coverage Report</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f6f8fa; }
                  .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; padding: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                  .header { border-bottom: 1px solid #e1e4e8; padding-bottom: 20px; margin-bottom: 30px; }
                  .coverage-badge { margin: 10px 0; }
                  .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
                  .metric { padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #e1e4e8; }
                  .metric h3 { margin: 0 0 10px 0; color: #586069; font-size: 14px; font-weight: 600; }
                  .metric .value { font-size: 2em; font-weight: bold; color: $STATUS_COLOR; }
                  .links { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e1e4e8; }
                  .btn { display: inline-block; padding: 10px 20px; background: #0366d6; color: white; text-decoration: none; border-radius: 6px; margin-right: 10px; margin-bottom: 10px; }
                  .btn:hover { background: #0256cc; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ðŸ§ª Tempo AI - Test Coverage Report</h1>
                      <p>Automatically generated test coverage report</p>
                      <div class="coverage-badge">
                          <img src="$COVERAGE_BADGE_URL" alt="Coverage Badge">
                      </div>
                      <p><strong>Last Updated:</strong> $CURRENT_TIME</p>
                  </div>
                  
                  <div class="metrics">
                      <div class="metric"><h3>Overall Coverage</h3><div class="value">$LINES%</div></div>
                      <div class="metric"><h3>Statements</h3><div class="value">$STATEMENTS%</div></div>
                      <div class="metric"><h3>Branches</h3><div class="value">$BRANCHES%</div></div>
                      <div class="metric"><h3>Functions</h3><div class="value">$FUNCTIONS%</div></div>
                      <div class="metric"><h3>Quality Gate</h3><div class="value">80%</div></div>
                      <div class="metric"><h3>Test Status</h3><div class="value">$STATUS_EMOJI</div></div>
                      <div class="metric"><h3>Platform</h3><div class="value">Backend</div></div>
                  </div>
                  
                  <h2>ðŸ“‹ Coverage Details</h2>
                  <p>Detailed coverage report is available in the HTML files below:</p>
                  
                  <div class="links">
                      <a href="./html/index.html" class="btn">ðŸ“„ Detailed HTML Report</a>
                      <a href="https://github.com/$GITHUB_REPOSITORY" class="btn">ðŸ“š GitHub Repository</a>
                      <a href="https://github.com/$GITHUB_REPOSITORY/actions" class="btn">ðŸ”„ CI/CD Pipeline</a>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Copy HTML coverage report
        if: github.event_name == 'push' || github.event_name == 'workflow_run'
        run: |
          mkdir -p ./public/html
          cp -r ./coverage/html ./public/

      - name: Setup Pages
        if: github.event_name == 'push' || github.event_name == 'workflow_run'
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        if: github.event_name == 'push' || github.event_name == 'workflow_run'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./backend/public

      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' || github.event_name == 'workflow_run'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const {
              STATEMENTS,
              BRANCHES,
              FUNCTIONS,
              LINES,
              COVERAGE_BADGE_URL,
            } = process.env;

            const body = `
ðŸ“Š **Backend Coverage**

![Coverage Badge](${COVERAGE_BADGE_URL})

- Statements: ${STATEMENTS}%
- Branches: ${BRANCHES}%
- Functions: ${FUNCTIONS}%
- Lines: ${LINES}%

_Generated by \`coverage.yml\`_
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = 'Backend Coverage';
            const existing = comments.find((c) => c.user?.login === 'github-actions[bot]' && c.body?.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
