# Tempo AI プロダクト仕様書

**バージョン**: 3.0  
**最終更新日**: 2025 年 12 月 11 日  
**ステータス**: MVP 開発準備中

---

## 目次

1. [プロダクト概要](#1-プロダクト概要)
2. [機能要件](#2-機能要件)
3. [トラベルモード](#3-トラベルモード)
4. [コンディション画面](#4-コンディション画面)
5. [データ要件](#5-データ要件)
6. [ユーザープロフィール設計](#6-ユーザープロフィール設計)
7. [オンボーディングフロー](#7-オンボーディングフロー)
8. [アドバイス生成ロジック](#8-アドバイス生成ロジック)
9. [エラーハンドリング](#9-エラーハンドリング)
10. [プライバシー・セキュリティ](#10-プライバシーセキュリティ)
11. [MVP スコープ](#11-mvpスコープ)
12. [関連ドキュメント](#12-関連ドキュメント)

---

## 1. プロダクト概要

### 1.1 プロダクト名

**Tempo AI**（英語表記）

### 1.2 コンセプト

「自分のテンポで、健やかな毎日を」

Tempo AI は、ユーザーの生体リズム・活動量・回復速度などのヘルスケアデータと、気象・環境データを組み合わせて AI が分析し、**その日の過ごし方**をパーソナライズしてアドバイスするヘルスケアアプリです。

「テンポ」とは、その人固有の生体リズム、活動量の変動パターン、HRV（心拍変動）に表れる自律神経の状態、サーカディアンリズムなどを指します。静的な健康スコアではなく、「今日のあなたに合った過ごし方」を毎朝提案することで、ユーザーが自分のペースで健康を推進できるようサポートします。

### 1.3 ターゲットユーザー

- **属性**: 年齢層・性別は問わない
- **特徴**:
  - 健康意識があり、ヘルスケアを管理したいと考えている
  - データに基づいたヘルスケア解析に興味がある
  - 何らかの不調を抱えている、またはパフォーマンスを向上させたい
  - 日常的にリラックス・チルしたい
  - デジタルノマド、出張の多いビジネスパーソン
  - 旅行好きな方、時差や環境変化の影響を受けやすい方
- **前提**: Apple Watch または iPhone でヘルスケアデータを記録している

### 1.4 解決する課題

- 健康データはあるが、どう活かせばいいかわからない
- 毎日の体調に合わせた具体的な行動指針がほしい
- 一般的な健康アドバイスではなく、自分に合ったパーソナライズされた情報がほしい
- 天気や環境の変化が体調に与える影響を理解したい
- 移動や時差で乱れた生体リズムを整えたい

### 1.5 重要な制約

**医学的なアドバイス・診断は絶対に行わない**

Tempo AI は健康的なライフスタイルをサポートするためのウェルネスアプリであり、医療行為・医学的診断・治療の代替となるものではありません。

---

## 2. 機能要件

### 2.1 画面構成

| タブ           | 役割                         |
| -------------- | ---------------------------- |
| ホーム         | 今日のアドバイス、トライ提案 |
| コンディション | 健康状態のダッシュボード     |
| 設定           | プロフィール編集、各種設定   |

### 2.2 メインアドバイス機能

#### 2.2.1 概要

毎日 1 回、ユーザーがアプリを開いたときに、その日のパーソナライズされたアドバイスを生成・表示します。

#### 2.2.2 生成タイミング

| 条件                     | 動作                                                          |
| ------------------------ | ------------------------------------------------------------- |
| その日初めてアプリを起動 | アドバイスを新規生成                                          |
| 同日中に再度起動         | 生成済みのアドバイスを表示（再生成しない）                    |
| 時間制限                 | なし（23 時に開いても「今日のアドバイス」として生成）         |
| オフライン時             | 「最新情報を取得できません」メッセージ + 前日のアドバイス表示 |
| 初回起動時               | オンボーディング完了直後にアドバイス生成                      |

#### 2.2.3 アドバイスの構成要素（通常モード）

| セクション           | 内容                                           | 長さ目安 |
| -------------------- | ---------------------------------------------- | -------- |
| 挨拶                 | 「〇〇さん、おはようございます」               | 1 文     |
| 今日のコンディション | 昨夜の睡眠・今朝の体の状態・気象情報・総合評価 | 5-8 文   |
| 具体的な行動提案     | データに基づいた 3-5 個のアクション + 根拠     | 10-15 文 |
| 今日のトライ         | 1 日 1 つの新しいチャレンジ提案                | 5-7 文   |
| お見送りメッセージ   | 温かい締めの一言                               | 1-2 文   |

#### 2.2.4 アドバイスのパーソナライズ要素

- ユーザーのニックネームを使用した呼びかけ
- 職業に基づいた具体的なアドバイス（例：デスクワーカーへの目の疲れ対策）
- 関心ごとタグに基づいた内容の重み付け
- 過去 7 日間・30 日間のトレンドとの比較
- 気象・大気汚染データとの掛け合わせ

---

### 2.3 今日のトライ機能

#### 2.3.1 概要

メインアドバイスの一部として、1 日 1 つの新しいチャレンジを提案します。

#### 2.3.2 特徴

| 項目           | 内容                                  |
| -------------- | ------------------------------------- |
| 難易度         | 低（5-15 分で完結、今夜試せるレベル） |
| 必要なもの     | 家にあるもの、または何も不要          |
| 多様性         | 過去 2 週間で提案していないもの       |
| 関心ごと反映率 | 70-80%                                |

#### 2.3.3 カテゴリー例

- ボディケア（マッサージ、ストレッチなど）
- メンタルケア（呼吸法、瞑想など）
- 栄養（特定の食材を取り入れるなど）
- 運動（軽いウォーキング、ルート変更など）
- 睡眠準備（デジタルデトックス、入浴法など）
- マインドフルネス（感謝日記、自然観察など）

---

### 2.4 今週のトライ機能

#### 2.4.1 概要

毎週月曜日に、その週を通して取り組むチャレンジを提案します。

#### 2.4.2 特徴

| 項目           | 内容                               |
| -------------- | ---------------------------------- |
| 表示タイミング | 毎週月曜日のメインアドバイスに含む |
| 難易度         | 中（週を通して取り組む）           |
| 必要なもの     | 購入や準備が必要でも OK            |
| 関心ごと反映率 | 70-80%                             |

#### 2.4.3 UI 表示ルール

| 曜日     | 表示                                                   |
| -------- | ------------------------------------------------------ |
| 月曜日   | 「今週のトライ」セクションが目立つ位置に表示           |
| 火〜日曜 | 「今週のトライ」は小さく表示、「今日のトライ」がメイン |

---

### 2.5 追加アドバイス機能（時間駆動型）

#### 2.5.1 概要

メインアドバイスに加えて、時間帯に応じた追加アドバイスを提供します（1 日最大 2 回）。

#### 2.5.2 提供タイミング

| 時間帯 | トリガー                           | 内容                                 |
| ------ | ---------------------------------- | ------------------------------------ |
| 昼     | 13:00 以降、その時間帯で初回起動時 | 午前中のデータに基づく短いアドバイス |
| 夕     | 18:00 以降、その時間帯で初回起動時 | 1 日のデータに基づく短いアドバイス   |

#### 2.5.3 特徴

| 項目           | 内容                                         |
| -------------- | -------------------------------------------- |
| 長さ           | 短め（2-3 文）                               |
| キャッシュ     | 同じ時間帯で再度開いても同じアドバイスを表示 |
| 1 日の最大回数 | 2 回まで                                     |

---

### 2.6 関心ごとタグ機能

#### 2.6.1 概要

ユーザーの関心事に基づいてアドバイスをパーソナライズします。

#### 2.6.2 タグカテゴリー（6 種類）

1. **エネルギー・パフォーマンス**
2. **栄養・食事**
3. **運動・フィットネス**
4. **メンタル・ストレス**
5. **美容・スキンケア**
6. **睡眠**

#### 2.6.3 選択ルール

| 項目           | 内容                         |
| -------------- | ---------------------------- |
| 選択数         | 1〜3 個（必須: 最低 1 個）   |
| 設定タイミング | 初回オンボーディング時       |
| 変更           | 設定画面からいつでも変更可能 |

#### 2.6.4 アドバイスへの影響範囲

| アドバイス種別   | 関心ごと反映率 |
| ---------------- | -------------- |
| メインアドバイス | 30-40%         |
| 今日のトライ     | 70-80%         |
| 今週のトライ     | 70-80%         |

---

## 3. トラベルモード

### 3.1 概要

移動が多い時期に、サーカディアンリズム調整を優先したアドバイスを提供するモードです。

> **コアコンセプト: 「環境が変わっても、自分のリズム（Tempo）を整える」**

トラベルモードの核心は以下の 3 点：

1. **リズムのずれに気づかせる** — 普段のパターンとの差分を可視化
2. **リセット方法を教える** — 光のタイミング、CT（余白時間）、カフェイン管理
3. **焦らせない** — 「適応期間である」という安心感を与える

### 3.2 基本仕様

| 項目       | 内容                                     |
| ---------- | ---------------------------------------- |
| 操作方法   | ON/OFF トグルスイッチ                    |
| 操作場所   | ホーム画面ヘッダー + 設定画面            |
| デフォルト | OFF                                      |
| 影響範囲   | アドバイス内容、コンディション画面の表示 |

### 3.3 トラベルモード ON 時の変化

| 要素               | 通常モード               | トラベルモード                     |
| ------------------ | ------------------------ | ---------------------------------- |
| アドバイスの焦点   | 今日のコンディション全般 | サーカディアンリズム調整           |
| アドバイス構造     | 状況説明 + 行動提案      | リズムのずれ + 光/CT/カフェイン    |
| 今日のトライ       | 関心ごとタグに基づく     | 場所を選ばない + リズム調整系      |
| コンディション画面 | 標準表示                 | 環境差分セクション追加、リズム強調 |
| トーン             | 「良い一日を」           | 「焦らず、余白を大切に」           |

### 3.4 アドバイスの構成要素（トラベルモード）

| セクション     | 内容                                                 |
| -------------- | ---------------------------------------------------- |
| 挨拶           | 「〇〇さん、おはようございます」                     |
| リズムの状況   | 昨夜の就寝と普段のリズムとのずれ、HRV の変化         |
| 光のタイミング | 朝の光を浴びるべき時間帯（例：7-9 時）               |
| CT（余白時間） | 予定を入れない休息時間の確保（例：13-15 時に 30 分） |
| カフェイン     | カットオフ時刻（例：14 時以降は控える）              |
| 今日のトライ   | 場所を選ばない、リズム調整に効果的な提案             |
| 適応の目安     | 「あと 2-3 日で体が慣れてきます」                    |

### 3.5 ロケーション管理

#### 3.5.1 3 つのロケーション

| 種類     | 説明           | 設定方法                 |
| -------- | -------------- | ------------------------ |
| Home     | ユーザーの拠点 | ユーザーが手動設定       |
| Current  | 今いる場所     | 自動検出                 |
| Previous | 前にいた場所   | 自動検出（7 日でクリア） |

#### 3.5.2 リセットルール

- 同じ場所に 7 日間以上滞在: Previous をクリア
- Current が拠点に戻った場合: 環境差分セクションを非表示

#### 3.5.3 環境差分の表示ルール

| 状態                              | 表示内容                          |
| --------------------------------- | --------------------------------- |
| Current ≠ Home かつ Previous あり | Home との比較 + Previous との比較 |
| Current ≠ Home かつ Previous なし | Home との比較のみ                 |
| Current = Home                    | 環境差分セクション非表示          |

### 3.6 今日のリセットポイント

トラベルモード時に表示される、体内時計リセットのための具体的な指針。

| 項目                   | 算出ロジック                                            |
| ---------------------- | ------------------------------------------------------- |
| 朝の光を浴びる最適時間 | 現地の日の出時刻〜日の出+3 時間                         |
| カフェインカットオフ   | 固定で 14:00                                            |
| 今夜の就寝目標         | 昨夜の就寝時刻 −30 分〜1 時間（段階的に理想に近づける） |

---

## 4. コンディション画面

### 4.1 概要

> **「自分の体のリズムが今どうなっているか」を数値とビジュアルで把握する**

ホーム画面が「今日どう過ごすか」のアドバイス中心なのに対し、コンディション画面は「自分の状態を客観的に見る」ためのダッシュボード。

### 4.2 コンディショントップ画面の構成

#### 通常モード

| セクション           | 表示内容                                 |
| -------------------- | ---------------------------------------- |
| サーカディアンリズム | 平均就寝・起床時刻、リズム安定度スコア   |
| HRV                  | 今朝の値、7 日平均との差、トレンド       |
| 睡眠                 | 昨夜の睡眠時間、深い睡眠の割合、7 日平均 |
| 活動量               | 今日の歩数、7 日平均、今週の運動回数     |
| 環境                 | 現在地の気温、湿度、AQI、気圧            |

#### トラベルモード時（追加表示）

| セクション | 表示内容                         |
| ---------- | -------------------------------- |
| 環境差分   | 拠点との気温差、湿度差、時差     |
| リズム状態 | 「調整中」表示、ずれの時間       |
| HRV 補足   | 「移動による一時的な低下」の説明 |
| 活動量補足 | 「移動日は少なくて OK」の説明    |

### 4.3 詳細画面一覧

| 画面                             | 内容                                                        |
| -------------------------------- | ----------------------------------------------------------- |
| サーカディアンリズム詳細         | 24 時間サークル図、週間トレンドグラフ、リズム安定度、ヒント |
| HRV 詳細                         | 今朝・7 日平均・30 日平均、週間トレンドグラフ、回復状態     |
| 睡眠詳細                         | 睡眠時間、深い睡眠・REM 睡眠の割合、週間トレンド            |
| 活動量詳細                       | 歩数、運動時間、消費カロリー、週間トレンド                  |
| 環境詳細                         | 気温、湿度、気圧、AQI、UV 指数                              |
| 環境差分詳細（トラベルモード時） | 拠点・前にいた場所との比較、適応のポイント                  |

### 4.4 リズム安定度スコア

#### 算出方法

```
安定度スコア = 100 - (就寝時刻の標準偏差 × 2.5 × 10) - (起床時刻の標準偏差 × 2.0 × 10)
```

#### 表示ランク

| スコア | ランク        |
| ------ | ------------- |
| 90-100 | 非常に安定 ✓✓ |
| 75-89  | 安定 ✓        |
| 60-74  | やや不安定 △  |
| 0-59   | 不安定 ▽      |

### 4.5 リズムを整えるヒント（条件分岐）

| 条件                                | 表示するヒント                                         |
| ----------------------------------- | ------------------------------------------------------ |
| 就寝が遅い傾向（平均 > 24:00）      | 「就寝を毎日 15-30 分ずつ早めてみましょう」            |
| 起床時刻のばらつきが大きい          | 「週末も平日と同じ時間に起きることが大切です」         |
| 就寝時刻のばらつきが大きい          | 「就寝前のルーティンを作りましょう」                   |
| リズムが安定している（スコア > 85） | 「素晴らしいリズムです。この調子を維持しましょう」     |
| トラベルモード ON                   | 「毎日少しずつ就寝を早めて、現地時間に合わせましょう」 |

---

## 5. データ要件

### 5.1 HealthKit データ

#### 5.1.1 取得データ一覧

**必須データ**

| データ種別                               | 用途                         |
| ---------------------------------------- | ---------------------------- |
| 心拍数（Heart Rate）                     | リアルタイムの体の状態把握   |
| 心拍変動 / HRV（Heart Rate Variability） | 自律神経・回復状態の評価     |
| 睡眠データ（Sleep Analysis）             | 睡眠の質・量の評価           |
| 歩数（Step Count）                       | 活動量の把握                 |
| 運動データ（Workout）                    | トレーニング強度・頻度の把握 |

**重要データ**

| データ種別                         | 用途                   |
| ---------------------------------- | ---------------------- |
| 安静時心拍数（Resting Heart Rate） | ベースラインの健康状態 |
| 血中酸素濃度（Blood Oxygen）       | 呼吸・循環器の状態     |
| 体温（Body Temperature）           | 体調変化の検知         |

**あれば嬉しいデータ**

| データ種別                              | 用途                               |
| --------------------------------------- | ---------------------------------- |
| 月経周期（Menstrual Cycle）             | ホルモンバランスに基づくアドバイス |
| マインドフルネス時間（Mindful Minutes） | メンタルケア習慣の把握             |
| 栄養データ（Nutrition）                 | 食事管理のアドバイス               |

#### 5.1.2 取得期間

| 期間         | 用途                           |
| ------------ | ------------------------------ |
| 直近 7 日間  | トレンド把握、直近の変化検知   |
| 過去 30 日間 | ベースライン確立、長期トレンド |

#### 5.1.3 データ保存ポリシー

- **保存場所**: デバイス内のみ（サーバーに保存しない）
- **理由**: プライバシー保護、GDPR・個人情報保護法への完全準拠

---

### 5.2 気象データ

#### 5.2.1 データソース

**Open-Meteo API**（無料）

#### 5.2.2 取得項目

| 項目                     | アドバイスへの影響               |
| ------------------------ | -------------------------------- |
| 気温（最高・最低・体感） | 運動強度、水分補給の提案         |
| 湿度                     | 肌ケア、呼吸器への影響           |
| 気圧                     | 体調変化（低気圧による不調など） |
| UV 指数                  | 外出時の紫外線対策               |
| 降水確率・降水量         | 屋外活動の提案調整               |
| 風速                     | 外出時のアドバイス               |

---

### 5.3 大気汚染データ

#### 5.3.1 データソース

**Open-Meteo Air Quality API**（無料、1 日 10,000 リクエストまで）

#### 5.3.2 取得項目

| 項目              | アドバイスへの影響         |
| ----------------- | -------------------------- |
| PM2.5             | 外出時のマスク着用、肌ケア |
| PM10              | 呼吸器への影響             |
| AQI（大気質指数） | 総合的な屋外活動の推奨度   |
| O3, NO2, SO2, CO  | 詳細な環境リスク評価       |

---

### 5.4 位置情報

| 項目             | 内容                                               |
| ---------------- | -------------------------------------------------- |
| 取得精度         | 都市レベルのみ                                     |
| 用途             | 気象データ・大気汚染データの取得、ロケーション管理 |
| プライバシー配慮 | 詳細な位置情報は取得・保存しない                   |

---

## 6. ユーザープロフィール設計

### 6.1 取得する情報一覧

#### 6.1.1 必須情報

| 項目         | 入力方式                              | 用途                       |
| ------------ | ------------------------------------- | -------------------------- |
| ニックネーム | テキスト入力                          | 「〇〇さん」の呼びかけ     |
| 年齢         | 数値入力 or 年代選択                  | 年齢に応じたアドバイス調整 |
| 性別         | 選択式（男性/女性/その他/回答しない） | 性別に応じたアドバイス     |
| 体重         | 数値入力（kg）                        | 運動・栄養アドバイスの基準 |
| 身長         | 数値入力（cm）                        | BMI 計算、運動アドバイス   |
| 関心ごとタグ | 複数選択（1-3 個）                    | アドバイスのパーソナライズ |

#### 6.1.2 任意情報（推奨）

| 項目                       | 入力方式 | 用途                         |
| -------------------------- | -------- | ---------------------------- |
| 職業カテゴリー             | 選択式   | 職業に応じた具体的アドバイス |
| 生活リズム                 | 選択式   | 睡眠・活動アドバイスの調整   |
| 運動習慣                   | 選択式   | 運動提案の強度調整           |
| 飲酒習慣                   | 選択式   | 飲酒影響を考慮したアドバイス |
| 拠点（ホームロケーション） | 都市選択 | サーカディアンリズムの基準   |

### 6.2 職業カテゴリー

| カテゴリー           | アドバイスの方向性                   |
| -------------------- | ------------------------------------ |
| 事務・オフィスワーク | 目の疲れ、座りっぱなし対策、姿勢改善 |
| 営業・接客           | 移動疲れ、対人ストレス管理           |
| サービス業           | 接客疲れ、立ち仕事対策               |
| 医療・介護           | 夜勤対応、不規則勤務の睡眠管理       |
| 教育・保育           | 声の疲れ、精神的疲労の回復           |
| 製造・技術           | 体力仕事、安全管理、疲労回復         |
| 運輸・物流           | 長時間運転、体力回復、腰痛対策       |
| IT・エンジニア       | 集中力維持、デジタル疲労対策         |
| クリエイティブ       | 集中力維持、インスピレーション       |
| 主婦・主夫           | 家事の合間のケア、育児疲れ           |
| 学生                 | 勉強の集中力、試験期間のストレス     |
| その他               | 汎用的なアドバイス                   |

### 6.3 生活リズム

| 選択肢 | 説明           |
| ------ | -------------- |
| 朝型   | 早寝早起き傾向 |
| 夜型   | 遅寝遅起き傾向 |
| 不規則 | シフト勤務など |

### 6.4 運動習慣

| 選択肢         | 説明         |
| -------------- | ------------ |
| ほぼ毎日       | 週 5 回以上  |
| 週 3-4 回      | 定期的に運動 |
| 週 1-2 回      | 時々運動     |
| ほとんどしない | 運動習慣なし |

### 6.5 飲酒習慣

| 選択肢      | 説明         |
| ----------- | ------------ |
| 飲まない    | 禁酒         |
| 月数回      | たまに飲む   |
| 週 1-2 回   | 定期的に飲む |
| 週 3 回以上 | 頻繁に飲む   |

---

## 7. オンボーディングフロー

### 7.1 画面遷移

```text
画面1: ウェルカム
    ↓
画面2: ニックネーム入力（必須）
    ↓
画面3: 基本情報入力（年齢・性別・体重・身長）
    ↓
画面4: 職業・生活習慣・拠点入力（任意）
    ↓
画面5: 関心ごとタグ選択（1-3個、必須）
    ↓
画面6: 権限リクエスト（HealthKit・位置情報）
    ↓
画面7: データ取得中（ローディング）
    ↓
画面8: ホーム画面（初回アドバイス表示）
```

### 7.2 各画面の詳細

#### 画面 1: ウェルカム

- 美しいビジュアル（Tempo AI のコンセプト表現）
- キャッチコピー: 「あなたのテンポで、健やかな毎日を」
- 3 つの特徴を簡潔に説明
- 「始める」ボタン

#### 画面 2: ニックネーム入力

- タイトル: 「あなたのお名前を教えてください」
- 説明: 「毎朝、あなたの名前でご挨拶します」
- テキスト入力フィールド
- 入力例: 「マサ」「あやか」など
- 「次へ」ボタン（入力必須）

#### 画面 3: 基本情報入力

- タイトル: 「基本情報を教えてください」
- 説明: 「より精度の高いアドバイスをお届けするために使用します」
- 入力項目:
  - 年齢（数値入力 or ピッカー）
  - 性別（選択式）
  - 体重（数値入力、kg）
  - 身長（数値入力、cm）
- 「次へ」ボタン

#### 画面 4: 職業・生活習慣・拠点入力

- タイトル: 「もう少し教えてください」
- 説明: 「あなたの生活スタイルに合わせたアドバイスができます（任意）」
- 入力項目:
  - 職業カテゴリー（選択式）
  - 生活リズム（選択式）
  - 運動習慣（選択式）
  - 拠点（ホームロケーション）（都市検索入力）
- 拠点の補足説明: 「サーカディアンリズムの基準になります」
- 「スキップ」リンク + 「次へ」ボタン

#### 画面 5: 関心ごとタグ選択

- タイトル: 「あなたの関心ごとを教えてください」
- 説明: 「1〜3 個選んでください」
- 6 つのタグをカード形式で表示
- タップで選択状態に
- 「次へ」ボタン（最低 1 個選択必須）

#### 画面 6: 権限リクエスト

- タイトル: 「Tempo AI に必要な権限」
- 説明: 各権限の理由を簡潔に説明
  - ヘルスケアデータ: 「睡眠や心拍数などのデータを分析します」
  - 位置情報: 「天気や大気汚染の情報を取得します（都市レベルのみ）」
- 「許可して始める」ボタン

#### 画面 7: データ取得中

- ローディング画面
- メッセージ: 「あなた専用のアドバイスを準備中...」
- プログレスインジケーター
- 30 日分の HealthKit データ取得

#### 画面 8: ホーム画面

- 初回アドバイス表示

---

## 8. アドバイス生成ロジック

### 8.1 生成フロー（通常モード）

```
1. ユーザーがアプリを起動
    ↓
2. キャッシュ確認（同日・同時間帯のアドバイスがあるか）
    ↓ なければ
3. HealthKitからデータ取得（デバイス内）
    ↓
4. 位置情報から気象・大気汚染データ取得
    ↓
5. ユーザープロフィール + HealthKitデータ + 環境データを統合
    ↓
6. AI（Claude API）にデータ送信・アドバイス生成
    ↓
7. アドバイスをキャッシュ・表示
```

### 8.2 生成フロー（トラベルモード）

```
1. ユーザーがアプリを起動
    ↓
2. キャッシュ確認
    ↓ なければ
3. HealthKitからデータ取得
    ↓
4. 現在地の気象データ取得
    ↓
5. 拠点（Home）の気象データ取得
    ↓
6. 環境差分を計算（気温差、湿度差、時差）
    ↓
7. 通常データ + ロケーション情報 + 環境差分 + トラベルコンテキストを統合
    ↓
8. AI（Claude API）にデータ送信・トラベルモード用アドバイス生成
    ↓
9. アドバイスをキャッシュ・表示
```

### 8.3 時間帯別の生成ルール

| 時間帯       | 条件               | 生成内容                              |
| ------------ | ------------------ | ------------------------------------- |
| 〜12:59      | その日初回起動     | メインアドバイス（フル）              |
| 13:00〜17:59 | その時間帯初回起動 | メインアドバイス + 昼の追加アドバイス |
| 18:00〜      | その時間帯初回起動 | メインアドバイス + 夕の追加アドバイス |

### 8.4 キャッシュ戦略

| キー構造                        | TTL     |
| ------------------------------- | ------- |
| `${deviceId}:${date}:morning`   | 24 時間 |
| `${deviceId}:${date}:afternoon` | 24 時間 |
| `${deviceId}:${date}:evening`   | 24 時間 |

### 8.5 AI プロンプト構造

```
Layer 1: システムプロンプト（静的・キャッシュ対象）
  - 役割定義、禁止事項、トーン、出力形式
  - TTL: 1時間

Layer 2: 例文（関心ごとに応じて動的選択）
  - 良好版・疲労版の例文
  - TTL: 5分

Layer 2.5: トラベルモードコンテキスト（トラベルモード時のみ）
  - サーカディアンリズム調整の優先指示
  - 光/CT/カフェインの具体的提案指示

Layer 3: ユーザーデータ（動的）
  - プロフィール、HealthKit、気象データ
  - トラベルモード時: ロケーション情報、環境差分を追加
```

### 8.6 AI 送信データ形式

AI プロンプトに送信するデータの詳細は、別途「アドバイス例文集・AI プロンプト設計書」を参照してください。

---

## 9. エラーハンドリング

### 9.1 エラーケースと対応

| エラーケース           | 対応                                               |
| ---------------------- | -------------------------------------------------- |
| オフライン             | 「最新情報を取得できません」+ 前日のアドバイス表示 |
| HealthKit データ不足   | 一般的なアドバイス + データ不足の説明メッセージ    |
| 気象データ取得失敗     | 気象関連アドバイスを省略して生成                   |
| 大気汚染データ取得失敗 | 大気汚染関連アドバイスを省略して生成               |
| Claude API エラー      | フォールバック（一般的なアドバイス）表示           |
| 位置情報取得失敗       | 手動で都市を選択させるダイアログ表示               |

### 9.2 エラーメッセージ例

**オフライン時**

```
最新情報を取得できません。
インターネット接続を確認してください。
前日のアドバイスを表示しています。
```

**HealthKit データ不足時**

```
ヘルスケアデータが不足しています。
Apple Watchを装着して、数日間データを記録してください。
より精度の高いアドバイスをお届けできるようになります。
```

**位置情報取得失敗時**

```
位置情報を取得できませんでした。
天気情報を取得するため、お住まいの都市を選択してください。
```

### 9.3 エラーメッセージのトーン

- 通常トーン（優しいお姉さんトーンは適用しない）
- シンプルで分かりやすく
- ユーザーが次に取るべきアクションを明示

---

## 10. プライバシー・セキュリティ

### 10.1 データプライバシー方針

#### 10.1.1 基本原則

| 原則           | 内容                                   |
| -------------- | -------------------------------------- |
| データ最小化   | 必要最小限のデータのみ取得             |
| デバイス内処理 | HealthKit データはデバイス内のみに保存 |
| 匿名化         | AI 送信時は個人識別情報を除外          |
| 透明性         | データの使用目的を明確に説明           |

#### 10.1.2 AI 送信時のデータ処理

**送信するデータ**

- ニックネーム（呼びかけ用）
- 年齢、性別、体重、身長
- 職業カテゴリー、生活習慣
- 関心ごとタグ
- HealthKit 数値データ（集計・トレンド）
- 気象・大気汚染データ
- 都市名
- ロケーション情報（トラベルモード時）

**送信しないデータ**

- 本名、メールアドレス
- 詳細な位置情報（緯度・経度）
- デバイス固有 ID

### 10.2 必要なドキュメント（後日作成）

- プライバシーポリシー
- 利用規約
- HealthKit データ使用に関する説明（App Store 審査用）

---

## 11. MVP スコープ

### 11.1 Phase 1-14（MVP 初期リリース）に含まれる機能

- ✅ オンボーディングフロー（ニックネーム、基本情報、職業、生活習慣、関心ごと）
- ✅ HealthKit 基本データ取得（心拍数、HRV、睡眠、歩数、運動）
- ✅ 気象データ統合（Open-Meteo）
- ✅ 大気汚染データ統合（Open-Meteo Air Quality）
- ✅ 関心ごとタグ設定（1-3 個）
- ✅ 毎朝のメインアドバイス生成
- ✅ 今日のトライ提案
- ✅ 今週のトライ提案（月曜日）
- ✅ 追加アドバイス（昼・夕、時間駆動型）
- ✅ 設定画面（プロフィール編集、タグ変更）
- ✅ オフライン対応（前日アドバイス表示）

### 11.2 Phase 15: コンディション画面

- ✅ タブバーを 2 タブ →3 タブに変更
- ✅ コンディショントップ画面
- ✅ サーカディアンリズム詳細画面
- ✅ HRV 詳細画面
- ✅ 睡眠詳細画面
- ✅ 活動量詳細画面
- ✅ 環境詳細画面
- ✅ リズム安定度スコアの算出
- ✅ ヒントの条件分岐ロジック
- ✅ 週間トレンドグラフ

### 11.3 Phase 16: トラベルモード

- ✅ 設定画面にトグル追加
- ✅ ホーム画面ヘッダーにトグル追加
- ✅ オンボーディングに拠点設定を追加
- ✅ ロケーション管理（Home/Current/Previous）
- ✅ 環境差分詳細画面
- ✅ AI プロンプトの分岐（トラベルモード用コンテキスト）
- ✅ アドバイス内容の変化
- ✅ リセットポイントの算出ロジック

### 11.4 将来バージョンに含める機能

**v1.1 以降**

- ⏳ 過去のアドバイス履歴表示
- ⏳ プッシュ通知（朝のリマインダーなど）
- ⏳ アドバイスの詳細な根拠表示（「なぜこのアドバイス？」）
- ⏳ ダークモード対応
- ⏳ 通知設定のカスタマイズ

**v2.0 以降**

- 🔮 ユーザーアカウント（Apple Sign In）
- 🔮 データ同期（複数デバイス対応）
- 🔮 アドバイス履歴の分析・トレンド表示
- 🔮 多言語対応（英語）

---

## 12. 関連ドキュメント

| ドキュメント名                        | 内容                                       | ステータス |
| ------------------------------------- | ------------------------------------------ | ---------- |
| アドバイス例文集・AI プロンプト設計書 | ペルソナ別アドバイス例、AI プロンプト構造  | 作成済み   |
| UI/UX 仕様書                          | 詳細な画面設計、デザインシステム           | 作成予定   |
| 技術仕様書                            | アーキテクチャ、API 設計、データベース設計 | 作成予定   |
| プライバシーポリシー                  | データ取り扱いに関する法的文書             | 作成予定   |
| 利用規約                              | サービス利用に関する法的文書               | 作成予定   |

---

## 付録

### A. 用語集

| 用語                          | 説明                                                   |
| ----------------------------- | ------------------------------------------------------ |
| サーカディアンリズム          | 約 24 時間周期で変動する生理現象。体内時計。           |
| HRV（Heart Rate Variability） | 心拍変動。自律神経の状態や回復度を示す。               |
| CT（Control Time）            | 余白時間。予定を入れない休息の時間。                   |
| リズム安定度スコア            | 就寝・起床時刻のばらつきから算出するスコア。           |
| Home Location                 | ユーザーの拠点。サーカディアンリズムの基準。           |
| 環境差分                      | 現在地と拠点（または前にいた場所）との気象・時差の差。 |
| AQI                           | Air Quality Index（大気質指数）                        |

### B. データ構造

#### LocationHistory

```swift
struct LocationHistory: Codable {
    var home: LocationInfo?       // ホームロケーション（ユーザー設定）
    var current: LocationInfo?    // 現在地
    var previous: LocationInfo?   // 前にいた場所（7日でクリア）
    var currentLocationSince: Date?  // 現在地に来た日（7日カウント用）
}

struct LocationInfo: Codable {
    let city: String           // "バンコク"
    let country: String        // "タイ"
    let countryCode: String    // "TH"
    let timezone: String       // "Asia/Bangkok"
    let timezoneOffset: Int    // +7
    let latitude: Double
    let longitude: Double
}
```

---

**以上、Tempo AI プロダクト仕様書 v3.0**
