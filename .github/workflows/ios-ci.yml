name: iOS CI

on:
  push:
    branches: [main, develop]
    paths:
      - "ios/**/*.swift"
      - "ios/**/*.xc*"
      - ".github/workflows/ios-ci.yml"
      - ".swiftlint.yml"
      - "ios/TempoAI/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "ios/**/*.swift"
      - "ios/**/*.xc*"
      - ".github/workflows/ios-ci.yml"
      - ".swiftlint.yml"
      - "ios/TempoAI/**"
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³

# åŒã˜PRã®å¤ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
  SCHEME: TempoAI
  DESTINATION: "platform=iOS Simulator,OS=latest,name=iPhone 15 Pro"

jobs:
  # ===========================================================================
  # Job 1: SwiftLintï¼ˆUbuntu ã§å®Ÿè¡Œ - macOS ã® 1/10 ã®ã‚³ã‚¹ãƒˆï¼‰
  # ===========================================================================
  swiftlint:
    name: ğŸ§¹ SwiftLint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run SwiftLint
        uses: norio-nomura/action-swiftlint@3.2.1
        with:
          args: --strict
        env:
          DIFF_BASE: ${{ github.base_ref }}

  # ===========================================================================
  # Job 2: Buildï¼ˆSwiftLint æˆåŠŸå¾Œã«å®Ÿè¡Œï¼‰
  # ===========================================================================
  build:
    name: ğŸ”¨ Build
    runs-on: macos-14
    needs: swiftlint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      - name: List available simulators
        run: xcrun simctl list devices available

      # Swift Package Manager ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ã‚­ãƒ¼ãƒ ä¸€è¦§ã‚’ç¢ºèª
      - name: List schemes
        run: xcodebuild -list -project ios/TempoAI/TempoAI.xcodeproj

      # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
      - name: Build for testing
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project ios/TempoAI/TempoAI.xcodeproj \
            -scheme ${{ env.SCHEME }} \
            -destination "${{ env.DESTINATION }}" \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty --color

      # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜ï¼ˆãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ã§ä½¿ç”¨ï¼‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            $HOME/Library/Developer/Xcode/DerivedData/TempoAI-*/Build/Products
          retention-days: 1

  # ===========================================================================
  # Job 3: Unit Testsï¼ˆBuild æˆåŠŸå¾Œã«å®Ÿè¡Œï¼‰
  # ===========================================================================
  test:
    name: ğŸ§ª Unit Tests
    runs-on: macos-14
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # SPM ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¾©å…ƒ
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ~/Library/Developer/Xcode/DerivedData

      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run unit tests
        run: |
          set -o pipefail
          xcodebuild test \
            -project ios/TempoAI/TempoAI.xcodeproj \
            -scheme ${{ env.SCHEME }} \
            -destination "${{ env.DESTINATION }}" \
            -configuration Debug \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty --color --report junit --output test-results.xml

      # ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always() # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã‚‚å®Ÿè¡Œ
        with:
          name: test-results
          path: |
            test-results.xml
            TestResults.xcresult
          retention-days: 7

      # ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼ã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action/macos@v2
        if: always()
        with:
          files: test-results.xml
          check_name: "Unit Test Results"
          comment_mode: "off" # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆå¿…è¦ã«å¿œã˜ã¦onã«ï¼‰
