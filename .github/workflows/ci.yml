name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Call Backend CI
  backend:
    name: Backend
    uses: ./.github/workflows/backend.yml
    secrets: inherit

  # Call iOS CI
  ios:
    name: iOS
    uses: ./.github/workflows/ios.yml
    secrets: inherit

  # Call Coverage reporting (only on main branch)
  coverage:
    name: Coverage Report
    needs: [backend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/coverage.yml
    with:
      coverage-percent: ${{ needs.backend.outputs.coverage-percent }}
    secrets: inherit

  # CI Summary - final status check
  ci-summary:
    name: CI Summary
    needs: [backend, ios]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check results
        run: |
          echo "ğŸš€ CI Pipeline Results Summary"
          echo "=============================="
          echo ""

          # Backend results
          if [[ "${{ needs.backend.result }}" == "success" ]]; then
            echo "âœ… Backend: All checks passed"
            echo "   - TypeScript compilation âœ…"
            echo "   - Linting & formatting âœ…"  
            echo "   - Tests & coverage âœ…"
            echo "   - Build verification âœ…"
          else
            echo "âŒ Backend: Failed (${{ needs.backend.result }})"
          fi

          echo ""

          # iOS results
          if [[ "${{ needs.ios.result }}" == "success" ]]; then
            echo "âœ… iOS: All checks passed"
            echo "   - SwiftLint analysis âœ…"
            echo "   - Code formatting âœ…"
            echo "   - Build validation âœ…"
            echo "   - Unit tests âœ…"
          else
            echo "âŒ iOS: Failed (${{ needs.ios.result }})"
          fi

          echo ""

          # Overall status
          if [[ "${{ needs.backend.result }}" == "success" && "${{ needs.ios.result }}" == "success" ]]; then
            echo "ğŸ‰ Overall CI Status: SUCCESS"
            echo "All quality checks and tests passed!"
          else
            echo "ğŸ’¥ Overall CI Status: FAILURE"
            echo "One or more checks failed. Please review the logs above."
            exit 1
          fi

      - name: Coverage info
        if: needs.backend.outputs.coverage-percent != ''
        run: |
          echo ""
          echo "ğŸ“Š Test Coverage: ${{ needs.backend.outputs.coverage-percent }}%"

          COVERAGE=${{ needs.backend.outputs.coverage-percent }}
          if [ "${COVERAGE}" -ge 80 ]; then
            echo "ğŸ¯ Excellent coverage!"
          elif [ "${COVERAGE}" -ge 60 ]; then
            echo "âš ï¸ Good coverage, but room for improvement"
          else
            echo "ğŸš¨ Coverage below recommended threshold (60%)"
          fi
