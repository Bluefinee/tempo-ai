name: iOS CI

on:
  push:
    branches: [main, develop]
    paths:
      - "ios/**/*.swift"
      - "ios/**/*.xc*"
      - ".github/workflows/ios-ci.yml"
      - ".swiftlint.yml"
      - "ios/TempoAI/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "ios/**/*.swift"
      - "ios/**/*.xc*"
      - ".github/workflows/ios-ci.yml"
      - ".swiftlint.yml"
      - "ios/TempoAI/**"
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³

# åŒã˜PRã®å¤ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
  SCHEME: TempoAI
  PROJECT_PATH: ios/TempoAI/TempoAI.xcodeproj
  # ãƒ“ãƒ«ãƒ‰å°‚ç”¨ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿èµ·å‹•ä¸è¦ï¼‰
  BUILD_DESTINATION: "generic/platform=iOS Simulator"
  # ãƒ†ã‚¹ãƒˆç”¨ï¼ˆå®Ÿéš›ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãŒå¿…è¦ï¼‰
  TEST_DESTINATION: "platform=iOS Simulator,name=iPhone 16,OS=latest"
  # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ï¼ˆ60%ã‹ã‚‰é–‹å§‹ã€ã‚µãƒ¼ãƒ“ã‚¹å±¤ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œ80%ã«å¼•ãä¸Šã’ï¼‰
  COVERAGE_THRESHOLD: 60

jobs:
  # ===========================================================================
  # Job 1: SwiftLintï¼ˆUbuntu ã§å®Ÿè¡Œ - macOS ã® 1/10 ã®ã‚³ã‚¹ãƒˆï¼‰
  # ===========================================================================
  swiftlint:
    name: ğŸ§¹ SwiftLint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run SwiftLint
        uses: norio-nomura/action-swiftlint@3.2.1
        with:
          args: --strict
        env:
          DIFF_BASE: ${{ github.base_ref }}

  # ===========================================================================
  # Job 2: Build Debugï¼ˆSwiftLint æˆåŠŸå¾Œã«å®Ÿè¡Œï¼‰
  # ===========================================================================
  build-debug:
    name: ğŸ”¨ Build (Debug)
    runs-on: macos-15
    needs: swiftlint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      # Swift Package Manager ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ã‚­ãƒ¼ãƒ ä¸€è¦§ã‚’ç¢ºèª
      - name: List schemes
        run: xcodebuild -list -project ${{ env.PROJECT_PATH }}

      # Debug ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œï¼ˆgeneric destination ã§ãƒ“ãƒ«ãƒ‰ã®ã¿ï¼‰
      - name: Build (Debug)
        run: |
          set -o pipefail
          xcodebuild build \
            -project ${{ env.PROJECT_PATH }} \
            -scheme ${{ env.SCHEME }} \
            -destination "${{ env.BUILD_DESTINATION }}" \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty --color

      # ãƒ“ãƒ«ãƒ‰æˆæœç¢ºèª
      - name: Verify build output
        run: |
          echo "âœ… Debug build completed successfully"

  # ===========================================================================
  # Job 3: Build Releaseï¼ˆApp Storeæº–å‚™å“è³ªãƒã‚§ãƒƒã‚¯ï¼‰
  # ===========================================================================
  build-release:
    name: ğŸš€ Build (Release)
    runs-on: macos-15
    needs: swiftlint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      # Swift Package Manager ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # Release ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œï¼ˆgeneric destination ã§ãƒ“ãƒ«ãƒ‰ã®ã¿ï¼‰
      - name: Build (Release)
        run: |
          set -o pipefail
          xcodebuild build \
            -project ${{ env.PROJECT_PATH }} \
            -scheme ${{ env.SCHEME }} \
            -destination "${{ env.BUILD_DESTINATION }}" \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty --color

      # Release ãƒ“ãƒ«ãƒ‰æˆæœç¢ºèª
      - name: Verify Release build
        run: |
          echo "âœ… Release build completed successfully"
          echo "ğŸ“¦ App Store deployment ready"

  # ===========================================================================
  # Job 4: Unit Tests with Coverageï¼ˆBuild æˆåŠŸå¾Œã«å®Ÿè¡Œï¼‰
  # ===========================================================================
  test:
    name: ğŸ§ª Unit Tests
    runs-on: macos-15
    needs: build-debug

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version

      # åˆ©ç”¨å¯èƒ½ãªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      - name: List available simulators
        run: |
          echo "ğŸ“± Available iOS Simulators:"
          xcrun simctl list devices available | grep -E "iPhone|iPad" | head -20

      # SPM ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¾©å…ƒ
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸æœ‰åŠ¹åŒ–ï¼‰
      - name: Run unit tests with coverage
        run: |
          set -o pipefail
          xcodebuild test \
            -project ${{ env.PROJECT_PATH }} \
            -scheme ${{ env.SCHEME }} \
            -destination "${{ env.TEST_DESTINATION }}" \
            -configuration Debug \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty --color

      # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      - name: Generate coverage report
        run: |
          echo "ğŸ“Š Code Coverage Summary:"
          if ! xcrun xccov view --report TestResults.xcresult | head -50; then
            echo "âš ï¸ Warning: Coverage report generation failed or xcresult bundle is invalid"
          fi

      # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯
      - name: Check coverage threshold
        run: |
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯è­¦å‘Šï¼‰
          COVERAGE=$(xcrun xccov view --report TestResults.xcresult 2>/dev/null | grep "TempoAI.app" | awk '{print $NF}' | tr -d '%' || echo "0")

          if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "0" ]; then
            echo "::warning::Could not extract coverage percentage from xcresult bundle"
            echo "âš ï¸ Coverage extraction failed - this may indicate a tooling issue"
            exit 1
          fi

          echo "ğŸ“ˆ Total coverage: ${COVERAGE}%"
          echo "ğŸ¯ Threshold: ${{ env.COVERAGE_THRESHOLD }}%"

          # é–¾å€¤ãƒã‚§ãƒƒã‚¯ï¼ˆæ•´æ•°æ¯”è¼ƒï¼‰
          THRESHOLD=${{ env.COVERAGE_THRESHOLD }}
          COVERAGE_INT=${COVERAGE%.*}

          if [ "$COVERAGE_INT" -lt "$THRESHOLD" ]; then
            echo "âŒ Coverage ${COVERAGE}% is below ${THRESHOLD}% threshold"
            exit 1
          fi

          echo "âœ… Coverage ${COVERAGE}% meets ${THRESHOLD}% threshold"

      # ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: TestResults.xcresult
          retention-days: 30

      - name: Test completed
        run: |
          echo "âœ… All unit tests passed with coverage reporting"
