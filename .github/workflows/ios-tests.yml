name: iOS Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'ios/**'
      - '.github/workflows/ios-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'ios/**'
      - '.github/workflows/ios-tests.yml'

env:
  XCODE_VERSION: '15.4'
  IOS_SIMULATOR_DEVICE: 'iPhone 15'
  IOS_SIMULATOR_OS: '17.2'

jobs:
  ios-tests:
    name: iOS Tests and Build
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
      
    - name: Show Xcode and SDK versions
      run: |
        xcodebuild -version
        xcodebuild -showsdks
        
    - name: Cache Xcode DerivedData
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-xcode-deriveddata-${{ hashFiles('ios/TempoAI/TempoAI.xcodeproj/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-xcode-deriveddata-
          
    - name: List available simulators
      run: xcrun simctl list devices available
      
    - name: Create iOS Simulator
      run: |
        DEVICE_UDID=$(xcrun simctl create "Test iPhone" "com.apple.CoreSimulator.SimDeviceType.iPhone-15" "com.apple.CoreSimulator.SimRuntime.iOS-17-2")
        echo "SIMULATOR_UDID=$DEVICE_UDID" >> $GITHUB_ENV
        xcrun simctl boot "$DEVICE_UDID"
        
    - name: Wait for simulator to boot
      run: |
        while [ "$(xcrun simctl list devices | grep "${{ env.SIMULATOR_UDID }}" | grep -o "Booted\|Shutdown")" != "Booted" ]; do
          echo "Waiting for simulator to boot..."
          sleep 5
        done
        echo "Simulator booted successfully"
        
    - name: Run SwiftLint
      run: |
        cd ios/TempoAI
        if which swiftlint > /dev/null; then
          swiftlint lint --reporter github-actions-logging
        else
          echo "SwiftLint not installed, skipping..."
        fi
      continue-on-error: true
      
    - name: Build iOS App for Testing
      run: |
        cd ios/TempoAI
        xcodebuild clean build-for-testing \
          -project TempoAI.xcodeproj \
          -scheme TempoAI \
          -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          -quiet
          
    - name: Run iOS Tests
      run: |
        cd ios/TempoAI
        xcodebuild test-without-building \
          -project TempoAI.xcodeproj \
          -scheme TempoAI \
          -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
          -configuration Debug \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          -resultBundlePath TestResults \
          | xcpretty --report html --output ios-test-report.html
          
    - name: Parse Test Results
      id: test-results
      run: |
        cd ios/TempoAI
        if [ -d "TestResults.xcresult" ]; then
          # Extract test results
          xcrun xcresulttool get --format json --path TestResults.xcresult > test_results.json
          
          # Parse results for summary
          TESTS_PASSED=$(cat test_results.json | jq -r '.actions._values[] | select(.actionResult.testsRef != null) | .actionResult.testsRef.id._value' | head -1 | xargs -I {} xcrun xcresulttool get --format json --path TestResults.xcresult --id {} | jq '.summaries._values[] | .testableSummaries._values[] | .tests._values[] | .subtests._values[] | .subtests._values[] | select(.testStatus == "Success") | .name' | wc -l)
          
          TESTS_FAILED=$(cat test_results.json | jq -r '.actions._values[] | select(.actionResult.testsRef != null) | .actionResult.testsRef.id._value' | head -1 | xargs -I {} xcrun xcresulttool get --format json --path TestResults.xcresult --id {} | jq '.summaries._values[] | .testableSummaries._values[] | .tests._values[] | .subtests._values[] | .subtests._values[] | select(.testStatus == "Failure") | .name' | wc -l)
          
          echo "TESTS_PASSED=$TESTS_PASSED" >> $GITHUB_ENV
          echo "TESTS_FAILED=$TESTS_FAILED" >> $GITHUB_ENV
          
          echo "‚úÖ Tests Passed: $TESTS_PASSED"
          echo "‚ùå Tests Failed: $TESTS_FAILED"
          
          # Fail if any tests failed
          if [ "$TESTS_FAILED" -gt 0 ]; then
            echo "‚ùå Some tests failed!"
            exit 1
          fi
        else
          echo "‚ö†Ô∏è No test results found"
          exit 1
        fi
        
    - name: Generate Coverage Report (if available)
      run: |
        cd ios/TempoAI
        if [ -d "TestResults.xcresult" ]; then
          # Try to extract coverage if available
          xcrun xcresulttool get --format json --path TestResults.xcresult > coverage_results.json
          echo "üìä Coverage report generated"
        else
          echo "‚ö†Ô∏è No coverage data available"
        fi
      continue-on-error: true
      
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-test-results
        path: |
          ios/TempoAI/TestResults.xcresult
          ios/TempoAI/ios-test-report.html
          ios/TempoAI/test_results.json
        retention-days: 30
        
    - name: Upload SwiftLint Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: swiftlint-results
        path: ios/TempoAI/swiftlint-report*.json
        retention-days: 7
      continue-on-error: true
      
    - name: Comment Test Results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const testsPassed = process.env.TESTS_PASSED || 'N/A';
          const testsFailed = process.env.TESTS_FAILED || 'N/A';
          
          const comment = `
          ## üì± iOS Test Results
          
          | Result | Count |
          |--------|-------|
          | ‚úÖ Tests Passed | ${testsPassed} |
          | ‚ùå Tests Failed | ${testsFailed} |
          
          ### Details
          - **Xcode Version**: ${{ env.XCODE_VERSION }}
          - **iOS Simulator**: ${{ env.IOS_SIMULATOR_DEVICE }} (${{ env.IOS_SIMULATOR_OS }})
          - **Build Status**: ${testsFailed === '0' ? '‚úÖ Success' : '‚ùå Failed'}
          
          ${testsFailed === '0' ? 'üéâ All iOS tests passed!' : '‚ö†Ô∏è Some tests failed. Please check the test results for details.'}
          
          [View detailed test results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: Cleanup Simulator
      if: always()
      run: |
        if [ ! -z "${{ env.SIMULATOR_UDID }}" ]; then
          xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}"
          xcrun simctl delete "${{ env.SIMULATOR_UDID }}"
        fi
        
  build-archive:
    name: Build iOS Archive (Release)
    runs-on: macos-14
    if: github.ref == 'refs/heads/main'
    needs: ios-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
      
    - name: Build Release Archive
      run: |
        cd ios/TempoAI
        xcodebuild clean archive \
          -project TempoAI.xcodeproj \
          -scheme TempoAI \
          -configuration Release \
          -destination "generic/platform=iOS" \
          -archivePath TempoAI.xcarchive \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          -quiet
          
    - name: Validate Archive
      run: |
        cd ios/TempoAI
        if [ -d "TempoAI.xcarchive" ]; then
          echo "‚úÖ Archive created successfully"
          ls -la TempoAI.xcarchive/
        else
          echo "‚ùå Archive creation failed"
          exit 1
        fi
        
    - name: Upload Archive
      uses: actions/upload-artifact@v4
      with:
        name: ios-archive
        path: ios/TempoAI/TempoAI.xcarchive
        retention-days: 30
