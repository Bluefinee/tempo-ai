name: Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  api-tests:
    name: API Unit & Integration Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"
          cache-dependency-path: "./backend/pnpm-lock.yaml"

      - name: Enable Corepack (pnpm)
        run: corepack enable

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage/lcov.info
          flags: api
          name: api-coverage

  ios-tests:
    name: iOS Unit Tests
    runs-on: macos-latest
    env:
      XCODE_VERSION: "15.4"
      IOS_DESTINATION: "platform=iOS Simulator,name=iPhone 15,OS=17.2"
    defaults:
      run:
        working-directory: ./ios

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Run iOS tests
        run: |
          xcodebuild test \
            -project TempoAI/TempoAI.xcodeproj \
            -scheme TempoAI \
            -configuration Debug \
            -destination '${{ env.IOS_DESTINATION }}' \
            -enableCodeCoverage YES \
            -derivedDataPath ./DerivedData

      - name: Generate test coverage report
        run: |
          xcrun xccov view --report --json ./DerivedData/Logs/Test/*.xcresult > coverage.json
          echo "iOS test coverage generated"

      - name: Upload iOS coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./ios/coverage.json
          flags: ios
          name: ios-coverage

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [api-tests, ios-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.api-tests.result }}" == "failure" || 
                "${{ needs.ios-tests.result }}" == "failure" ]]; then
            echo "âŒ Tests failed - Please fix failing tests"
            exit 1
          else
            echo "âœ… All tests passed"
            echo "ğŸ”— API Tests: ${{ needs.api-tests.result }}"
            echo "ğŸ”— iOS Tests: ${{ needs.ios-tests.result }}"
          fi
