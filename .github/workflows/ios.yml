name: iOS CI

on:
  push:
    branches: [main, develop]
    paths: ['ios/**']
  pull_request:
    branches: [main, develop]
    paths: ['ios/**']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-and-build:
    name: iOS Quality & Build
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install SwiftLint
        run: |
          echo "ðŸ“¦ Installing SwiftLint..."
          brew install swiftlint
          
      - name: Install swift-format
        run: |
          echo "ðŸ“¦ Installing swift-format..."
          brew install swift-format
          
      - name: Run SwiftLint
        working-directory: ./ios
        run: |
          echo "ðŸ§¹ Running SwiftLint..."
          swiftlint --reporter github-actions-logging
        continue-on-error: true
          
      - name: Run swift-format check
        working-directory: ./ios
        run: |
          echo "ðŸŽ¨ Checking Swift formatting..."
          swift-format --recursive --mode diff TempoAI/TempoAI/ || echo "Format check completed"
        continue-on-error: true
          
      - name: Cache Swift Packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
            ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-
            
      - name: Build Project
        working-directory: ./ios
        run: |
          echo "ðŸ”¨ Building iOS project..."
          xcodebuild build \
            -project TempoAI/TempoAI.xcodeproj \
            -scheme TempoAI \
            -destination 'generic/platform=iOS' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            -quiet
            
      - name: Summary
        if: always()
        run: |
          echo "ðŸ“Š iOS CI Summary"
          echo "=================="
          echo "âœ… Build: Compilation validation completed"
          echo "ðŸ’¡ iOS quality checks completed successfully."