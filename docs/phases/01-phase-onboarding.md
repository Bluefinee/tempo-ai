# Phase 1: オンボーディング設計書

**フェーズ**: 1 / 14  
**Part**: A（iOS UI）  
**前提フェーズ**: なし（独立）

---

## このフェーズで実現すること

1. **オンボーディング全7画面**の実装と画面遷移
2. **HealthKit権限リクエスト**と実際のデータ取得
3. **位置情報権限リクエスト**と位置取得
4. **ユーザープロフィール**のUserDefaults保存
5. **テストデータ生成**（シミュレータ用、DEBUG時のみ）

---

## 完了条件

- [ ] 全7画面が実装され、順番に遷移できる
- [ ] 進捗表示（1/7〜5/7）が画面2〜6に正しく表示される（画面7は進捗表示なし）
- [ ] ニックネーム、基本情報、関心ごとタグがUserDefaultsに保存される
- [ ] HealthKit権限ダイアログが表示され、許可後にデータ取得できる
- [ ] 位置情報権限ダイアログが表示され、許可後に位置取得できる
- [ ] シミュレータでテストデータを使った動作確認ができる
- [ ] オンボーディング完了後、ホーム画面（Mockでよい）へ遷移する

---

## 画面一覧

| 画面 | 名称 | 必須入力 | 主な要素 |
|------|------|---------|---------|
| 1 | ウェルカム | - | ビジュアル、キャッチコピー、「始める」ボタン |
| 2 | ニックネーム入力 | ✓ | テキスト入力、進捗(1/7) |
| 3 | 基本情報入力 | ✓ | 年齢、性別、体重、身長 |
| 4 | 職業・生活習慣 | - | 職業、生活リズム、運動習慣、飲酒習慣（スキップ可） |
| 5 | 関心ごとタグ選択 | ✓ | 6つのタグから1〜3個選択 |
| 6 | 権限リクエスト | ✓ | HealthKit、位置情報の説明と許可ボタン |
| 7 | データ取得中 | - | ローディング表示、完了後自動遷移 |

---

## 画面詳細

### 画面1: ウェルカム

**目的**: Tempo AIのコンセプトを伝え、期待感を持ってもらう

**構成要素**:
- 上半分: ビジュアル画像（健康、自然、穏やかさをイメージ）
- キャッチコピー: 「あなたのテンポで、健やかな毎日を」
- 3つの特徴（チェックマーク付き）
- 「始める」ボタン

**遷移**: 「始める」タップ → 画面2へ

---

### 画面2: ニックネーム入力

**目的**: ユーザーの呼び名を取得

**構成要素**:
- 戻るボタン、進捗表示（1/7）
- タイトル: 「あなたのお名前を教えてください」
- 説明: 「毎朝、あなたの名前でご挨拶します」
- テキスト入力フィールド
- 「次へ」ボタン（入力必須、空欄時は非活性）

**バリデーション**:
- 1文字以上の入力で「次へ」が活性化
- 最大20文字程度

**遷移**: 「次へ」タップ → 画面3へ

---

### 画面3: 基本情報入力

**目的**: パーソナライズに必要な基本情報を取得

**構成要素**:
- 戻るボタン、進捗表示（2/7）
- タイトル: 「基本情報を教えてください」
- 入力項目:
  - 年齢（数値入力 or ピッカー）
  - 性別（選択式: 男性/女性/その他/回答しない）
  - 体重（数値入力、kg）
  - 身長（数値入力、cm）
- 「次へ」ボタン

**バリデーション**:
- 年齢: 18〜100
- 体重: 30〜200 kg
- 身長: 100〜250 cm

**遷移**: 「次へ」タップ → 画面4へ

---

### 画面4: 職業・生活習慣入力

**目的**: より詳細なパーソナライズ情報を取得（任意）

**構成要素**:
- 戻るボタン、進捗表示（3/7）
- タイトル: 「もう少し教えてください」
- 説明: 「あなたの生活スタイルに合わせたアドバイスができます（任意）」
- 入力項目（すべて選択式）:
  - 職業カテゴリー
  - 生活リズム（朝型/夜型/不規則）
  - 運動習慣
  - 飲酒習慣
- 「スキップ」リンク + 「次へ」ボタン

**遷移**: 
- 「次へ」タップ → 画面5へ
- 「スキップ」タップ → 画面5へ（未入力のまま）

---

### 画面5: 関心ごとタグ選択

**目的**: アドバイスのパーソナライズ方向を決定

**構成要素**:
- 戻るボタン、進捗表示（4/7）
- タイトル: 「あなたの関心ごとを教えてください」
- 説明: 「1〜3個選んでください」
- 6つのタグ（カード形式）:
  - 美容・スキンケア
  - フィットネス・トレーニング
  - メンタルヘルス・マインドフルネス
  - 仕事・パフォーマンス向上
  - 栄養・食事管理
  - 睡眠改善
- 「次へ」ボタン

**インタラクション**:
- タップで選択状態をトグル
- 選択数が1〜3の範囲で「次へ」が活性化
- 4個目をタップしようとした場合は選択されない（またはトースト表示）

**遷移**: 「次へ」タップ → 画面6へ

---

### 画面6: 権限リクエスト

**目的**: HealthKitと位置情報の権限を取得

**構成要素**:
- 戻るボタン、進捗表示（5/7）
- タイトル: 「Tempo AIに必要な権限」
- 各権限の説明:
  - ヘルスケアデータ: 「睡眠や心拍数などのデータを分析します」
  - 位置情報: 「天気や大気汚染の情報を取得します（都市レベルのみ）」
- 「許可して始める」ボタン

**権限リクエストの順序**:
1. 「許可して始める」タップ
2. HealthKit権限ダイアログ表示
3. 位置情報権限ダイアログ表示
4. 両方完了後、画面7へ遷移

**注意**: 権限が拒否された場合もフローは継続（Phase 13でエラーハンドリング）

**遷移**: 権限リクエスト完了 → 画面7へ

---

### 画面7: データ取得中

**目的**: HealthKitからデータを取得し、初回アドバイス準備

**構成要素**:
- ローディングインジケーター
- メッセージ: 「あなた専用のアドバイスを準備中...」
- プログレス表示（任意）

**処理内容**:
1. HealthKitから過去30日分のデータを取得
2. 取得完了後、ホーム画面へ自動遷移

**遷移**: データ取得完了 → ホーム画面へ

---

## データモデル

### UserProfile

```
UserProfile
├── nickname: String（必須）
├── age: Int（必須）
├── gender: Gender（必須）
├── weightKg: Double（必須）
├── heightCm: Double（必須）
├── occupation: Occupation?（任意）
├── lifestyleRhythm: LifestyleRhythm?（任意）
├── exerciseFrequency: ExerciseFrequency?（任意）
├── alcoholFrequency: AlcoholFrequency?（任意）
└── interests: [Interest]（1〜3個、必須）
```

### 列挙型

**Gender**: male, female, other, notSpecified

**Occupation**: itEngineer, sales, standingWork, medical, creative, homemaker, student, freelance, other

**LifestyleRhythm**: morning, night, irregular

**ExerciseFrequency**: daily, threeToFour, oneToTwo, rarely

**AlcoholFrequency**: never, monthly, oneToTwo, threeOrMore

**Interest**: beauty, fitness, mentalHealth, workPerformance, nutrition, sleep

---

## 実装コンポーネント

### Views（Features/Onboarding/Views/）

- `OnboardingContainerView` - 全体のコンテナ、状態管理
- `WelcomeView` - 画面1
- `NicknameInputView` - 画面2
- `BasicInfoView` - 画面3
- `LifestyleView` - 画面4
- `InterestsView` - 画面5
- `PermissionsView` - 画面6
- `LoadingView` - 画面7

### Models（Features/Onboarding/Models/）

- `OnboardingState` - オンボーディングの進行状態

### Services（Services/）

- `HealthKitManager` - 権限リクエスト、データ取得
- `LocationManager` - 権限リクエスト、位置取得
- `CacheManager`（部分）- UserProfile保存

---

## HealthKitManager

### 権限リクエスト対象

**必須データ**:
- 心拍数（Heart Rate）
- 心拍変動 / HRV（Heart Rate Variability SDNN）
- 睡眠データ（Sleep Analysis）
- 歩数（Step Count）
- 運動データ（Workout）

**重要データ**:
- 安静時心拍数（Resting Heart Rate）
- 血中酸素濃度（Blood Oxygen）

### データ取得範囲

- 初回: 過去30日分
- 以降: 過去7日分（Phase 10以降で実装）

---

## LocationManager

### 権限レベル

- `When In Use`（使用中のみ）で十分

### 取得情報

- 緯度・経度（気象API用）
- 都市名（表示用、Reverse Geocoding）

---

## テストデータ生成（DEBUG用）

シミュレータでの動作確認用に、DEBUG時のみテストデータを生成する仕組みを用意する。

### 生成するデータ

- 過去30日分の睡眠データ
- 過去30日分の心拍数データ
- 過去30日分のHRVデータ
- 過去30日分の歩数データ

### 使用方法

- DEBUG時のみ有効
- 開発者が明示的に呼び出す（自動実行ではない）
- 既存データがある場合は上書きしない

---

## 状態管理

### OnboardingState

```
OnboardingState
├── currentStep: Int（1〜7）
├── nickname: String
├── basicInfo: BasicInfo?
├── lifestyle: Lifestyle?
├── interests: [Interest]
├── healthKitAuthorized: Bool
├── locationAuthorized: Bool
└── isCompleted: Bool
```

### 永続化

- `onboardingCompleted` フラグをUserDefaultsに保存
- アプリ起動時にフラグを確認し、未完了ならオンボーディングを表示

---

## 画面遷移フロー

```
アプリ起動
    │
    ├─ onboardingCompleted == true → ホーム画面
    │
    └─ onboardingCompleted == false
        │
        ↓
    画面1: ウェルカム
        │ [始める]
        ↓
    画面2: ニックネーム
        │ [次へ]
        ↓
    画面3: 基本情報
        │ [次へ]
        ↓
    画面4: 職業・生活習慣
        │ [次へ] or [スキップ]
        ↓
    画面5: 関心ごとタグ
        │ [次へ]
        ↓
    画面6: 権限リクエスト
        │ [許可して始める]
        │ → HealthKit権限ダイアログ
        │ → 位置情報権限ダイアログ
        ↓
    画面7: データ取得中
        │ (自動)
        ↓
    ホーム画面
```

---

## UI/UXポイント

### 進捗表示

- 画面2〜6で「1/7」〜「5/7」を表示
- ウェルカム画面とローディング画面では非表示

### 戻る操作

- 画面2以降で左上に戻るボタン
- スワイプで戻ることも可能（iOS標準動作）

### 入力バリデーション

- リアルタイムでバリデーション
- エラー時は入力フィールドの下に赤字でメッセージ
- 「次へ」ボタンはバリデーション通過まで非活性

### カラー

- Primary: Soft Sage Green
- Secondary: Warm Beige
- Accent: Soft Coral（CTAボタン）

---

## 関連ドキュメント

- `product-spec.md` - セクション5「オンボーディングフロー」
- `ui-spec.md` - セクション5「オンボーディング」
- `technical-spec.md` - セクション2.2〜2.3「主要クラス設計」「データモデル」

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-12-10 | 初版作成 |
