# Tempo AI トラベルモード & コンディション画面 設計仕様書

**バージョン**: 1.0  
**作成日**: 2025年12月11日  
**ステータス**: Phase 15-16 実装準備

---

## 目次

1. [概要](#1-概要)
2. [画面構成の変更](#2-画面構成の変更)
3. [トラベルモード設計](#3-トラベルモード設計)
4. [コンディション画面設計](#4-コンディション画面設計)
5. [ロケーション管理](#5-ロケーション管理)
6. [AIプロンプト設計](#6-aiプロンプト設計)
7. [データ算出ロジック](#7-データ算出ロジック)
8. [実装フェーズ](#8-実装フェーズ)

---

## 1. 概要

### 1.1 背景と目的

Tempo AIは「自分のテンポで、健やかな毎日を」をコンセプトとするヘルスケアアプリです。本ドキュメントでは、以下の2つの新機能を定義します。

1. **トラベルモード**: 移動が多い時期に、サーカディアンリズム調整を優先したアドバイスを提供
2. **コンディション画面**: 自分の健康状態を数値とビジュアルで客観的に把握するダッシュボード

### 1.2 ターゲットユーザー

- デジタルノマド、出張の多いビジネスパーソン
- 旅行好きな方
- 時差や環境変化の影響を受けやすい方
- 自分の健康データを詳しく把握したい一般ユーザー

### 1.3 コアコンセプト

> **「環境が変わっても、自分のリズム（Tempo）を整える」**

トラベルモードの核心は以下の3点：

1. **リズムのずれに気づかせる** — 普段のパターンとの差分を可視化
2. **リセット方法を教える** — 光のタイミング、CT（余白時間）、カフェイン管理
3. **焦らせない** — 「適応期間である」という安心感を与える

---

## 2. 画面構成の変更

### 2.1 タブ構成

| 旧構成 | 新構成 |
|--------|--------|
| ホーム / 設定 | **ホーム / コンディション / 設定** |

### 2.2 画面一覧（改訂版）

```
1. オンボーディング（全7画面）
   1-1. ウェルカム
   1-2. ニックネーム入力
   1-3. 基本情報入力
   1-4. 職業・生活習慣 ← 「拠点（ホームロケーション）」を追加
   1-5. 関心ごとタグ選択
   1-6. 権限リクエスト
   1-7. データ取得中

2. ホーム画面 ← トラベルモードで内容が変化

3. コンディション画面（新規）
   3-1. コンディショントップ
   3-2. サーカディアンリズム詳細
   3-3. HRV詳細
   3-4. 睡眠詳細
   3-5. 活動量詳細
   3-6. 環境詳細
   3-7. 環境差分詳細（トラベルモード時）

4. 詳細画面群
   4-1. アドバイス詳細
   4-2. 今日のトライ詳細
   4-3. 今週のトライ詳細

5. 設定画面
   5-1. 設定トップ ← トラベルモード設定を追加
   5-2. プロフィール編集 ← 拠点設定を追加
   5-3. 関心ごとタグ編集
   5-4. データとプライバシー
   5-5. アプリについて
```

### 2.3 画面遷移フロー

```
初回起動
    ↓
オンボーディング（1-1 → 1-7）
    ↓
┌─────────────────────────────────────────────────────────────┐
│                        メイン画面                           │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │             │  │             │  │             │         │
│  │   ホーム    │  │コンディション│  │    設定     │         │
│  │             │  │   (新規)    │  │             │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                │
└─────────┼────────────────┼────────────────┼────────────────┘
          │                │                │
          ▼                ▼                ▼
    ┌───────────┐    ┌───────────┐    ┌───────────┐
    │ アドバイス │    │ リズム詳細 │    │プロフィール│
    │   詳細    │    │ HRV詳細   │    │ タグ編集  │
    │ トライ詳細│    │ 睡眠詳細  │    │ 拠点設定  │
    └───────────┘    │ 活動詳細  │    └───────────┘
                     │ 環境詳細  │
                     │環境差分詳細│
                     └───────────┘
```

---

## 3. トラベルモード設計

### 3.1 基本仕様

| 項目 | 内容 |
|------|------|
| **操作方法** | ON/OFFトグルスイッチ |
| **操作場所** | ホーム画面ヘッダー + 設定画面 |
| **デフォルト** | OFF |
| **影響範囲** | アドバイス内容、コンディション画面の表示 |

### 3.2 トラベルモードON時の変化

| 要素 | 通常モード | トラベルモード |
|------|-----------|---------------|
| **アドバイスの焦点** | 今日のコンディション全般 | サーカディアンリズム調整 |
| **アドバイス構造** | 状況説明 + 行動提案 | リズムのずれ + 光/CT/カフェイン |
| **今日のトライ** | 関心ごとタグに基づく | 場所を選ばない + リズム調整系 |
| **コンディション画面** | 標準表示 | 環境差分セクション追加、リズム強調 |
| **トーン** | 「良い一日を」 | 「焦らず、余白を大切に」 |

### 3.3 ホーム画面（トラベルモードON時）

```
┌─────────────────────────────────────────┐
│ 12月16日（月）                          │
│ ☀️ バンコク 32°C              ✈️ [ON]  │ ← タップでON/OFF切替
├─────────────────────────────────────────┤
│                                         │
│ おはようございます                       │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🌙 今日のアドバイス                  │ │
│ │                                     │ │
│ │ マサさん、おはようございます。       │ │
│ │                                     │ │
│ │ 昨夜の就寝は現地1:15。普段のリズム  │ │
│ │ （23時頃）から約2時間ずれています。 │ │
│ │ HRVも58msと移動前より低下中。       │ │
│ │ 体内時計がまだ調整中ですね。        │ │
│ │                                     │ │
│ │ ─────────────────────────────────── │ │
│ │                                     │ │
│ │ ☀️ 光のタイミング                   │ │
│ │ 7-9時に15分、外の光を浴びて。       │ │
│ │                                     │ │
│ │ 🕐 CT（余白時間）                   │ │
│ │ 13-15時に30分の休息を計画して。     │ │
│ │                                     │ │
│ │ ☕ カフェイン                        │ │
│ │ 14時以降は控えましょう。            │ │
│ │                                     │ │
│ │              [詳しく見る]            │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌────────┬────────┬────────┬────────┐ │
│ │ [icon] │ [icon] │ [icon] │ [icon] │ │ ← カスタムアイコン
│ │ 睡眠   │ HRV    │ リズム │ 活動量 │ │
│ │  58    │  52ms  │  45    │  65    │ │
│ │ 普通   │ 回復中 │ 調整中 │ 良好   │ │
│ └────────┴────────┴────────┴────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ [ストレスグラフ - 24時間推移]       │ │
│ │ 現在: 変動あり                      │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🎯 今日のトライ                      │ │
│ │                                     │ │
│ │ 「4-7-8呼吸法で眠りを整える」       │ │
│ │ 今夜、就寝前に5分だけ。             │ │
│ │ 移動で高ぶった神経を鎮めます。      │ │
│ │                      [詳しく見る]   │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 💡 適応の目安                        │ │
│ │                                     │ │
│ │ あと2-3日で体が慣れてきます。       │ │
│ │ 焦らず、余白を大切に。              │ │
│ └─────────────────────────────────────┘ │
│                                         │
├─────────────────────────────────────────┤
│  [ホーム]  [コンディション]  [設定]     │
└─────────────────────────────────────────┘
```

### 3.4 ホーム画面（通常モード）

```
┌─────────────────────────────────────────┐
│ 12月16日（月）                          │
│ ☀️ 東京 12°C                 ✈️ [OFF]  │
├─────────────────────────────────────────┤
│                                         │
│ おはようございます                       │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🌙 今日のアドバイス                  │ │
│ │                                     │ │
│ │ マサさん、おはようございます。       │ │
│ │ 昨夜は7時間の良質な睡眠が取れま     │ │
│ │ したね。HRVは65msと安定しています。 │ │
│ │ 今日は集中力が高い一日になりそう    │ │
│ │ です。                              │ │
│ │                                     │ │
│ │              [詳しく見る]            │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌────────┬────────┬────────┬────────┐ │
│ │ [icon] │ [icon] │ [icon] │ [icon] │ │ ← カスタムアイコン
│ │ 睡眠   │ HRV    │ リズム │ 活動量 │ │
│ │  82    │  68ms  │  85    │  78    │ │
│ │ 良好   │ 良好   │ 安定   │ 良好   │ │
│ └────────┴────────┴────────┴────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ [ストレスグラフ - 24時間推移]       │ │
│ │ 現在: 安定                          │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🎯 今日のトライ                      │ │
│ │                                     │ │
│ │ 「朝の10分ストレッチ」              │ │
│ │ デスクワーク前に体をほぐして        │ │
│ │ 一日をスタートしましょう            │ │
│ │                      [詳しく見る]   │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 📅 今週のトライ（月曜のみ表示）      │ │
│ │                                     │ │
│ │ 「毎朝同じ時間に起きる習慣」        │ │
│ │ 週末も平日も、7時起床を             │ │
│ │ 目指してみましょう                  │ │
│ └─────────────────────────────────────┘ │
│                                         │
├─────────────────────────────────────────┤
│  [ホーム]  [コンディション]  [設定]     │
└─────────────────────────────────────────┘
```

### 3.5 設定画面でのトラベルモード

```
┌─────────────────────────────────────────┐
│ 設定                                    │
├─────────────────────────────────────────┤
│                                         │
│ アカウント                              │
│ ┌─────────────────────────────────────┐ │
│ │ 👤 プロフィール                  >  │ │
│ │ 🏷️ 関心ごとタグ                  >  │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ モード                                  │
│ ┌─────────────────────────────────────┐ │
│ │ ✈️ トラベルモード            [OFF]  │ │
│ │                                     │ │
│ │ 移動が多い時期に。                  │ │
│ │ サーカディアンリズム調整を          │ │
│ │ 優先したアドバイスに切り替えます。  │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ その他                                  │
│ ┌─────────────────────────────────────┐ │
│ │ 🔒 データとプライバシー          >  │ │
│ │ ℹ️ アプリについて                >  │ │
│ └─────────────────────────────────────┘ │
│                                         │
├─────────────────────────────────────────┤
│  [ホーム]  [コンディション]  [設定]     │
└─────────────────────────────────────────┘
```

---

## 4. コンディション画面設計

### 4.1 目的

> **「自分の体のリズムが今どうなっているか」を数値とビジュアルで把握する**

ホーム画面が「今日どう過ごすか」のアドバイス中心なのに対し、コンディション画面は「自分の状態を客観的に見る」ためのダッシュボード。

### 4.2 コンディション画面トップ（通常モード）

```
┌─────────────────────────────────────────┐
│ コンディション                 📅 今週 ▼│
├─────────────────────────────────────────┤
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ⏰ サーカディアンリズム         >   │ │
│ │                                     │ │
│ │ 就寝 23:15 / 起床 7:05（平均）      │ │
│ │ リズム安定度: 82 - 安定 ✓           │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ [icon] HRV                       >   │ │
│ │                                     │ │
│ │ 今朝 65ms / 7日平均 63ms (+2)       │ │
│ │ トレンド: 安定 →                    │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ [icon] 睡眠                      >   │ │
│ │                                     │ │
│ │ 昨夜 7h 00m / 深い睡眠 21%          │ │
│ │ 7日平均: 6h 45m                     │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🏃 活動量                        >   │ │
│ │                                     │ │
│ │ 今日 2,500歩 / 7日平均 8,200歩      │ │
│ │ 今週の運動: 2回                     │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🌡️ 環境                          >   │ │
│ │                                     │ │
│ │ 東京 12°C / 湿度 45% / AQI 42       │ │
│ │ 気圧 1018hPa（安定）                │ │
│ └─────────────────────────────────────┘ │
│                                         │
├─────────────────────────────────────────┤
│  [ホーム]  [コンディション]  [設定]     │
└─────────────────────────────────────────┘
```

### 4.3 コンディション画面トップ（トラベルモード）

```
┌─────────────────────────────────────────┐
│ コンディション                 📅 今週 ▼│
├─────────────────────────────────────────┤
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🌡️ 環境差分                     >   │ │ ← トラベルモード時のみ追加
│ │                                     │ │
│ │ 📍 バンコク 🇹🇭（現在）             │ │
│ │ 🏠 拠点（東京）との差分              │ │
│ │ 気温 +18°C / 湿度 +33% / 時差 -2h   │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ⏰ サーカディアンリズム         >   │ │ ← 上部に配置（強調）
│ │                                     │ │
│ │ ⚠️ 調整中 - ずれ 約2時間15分        │ │
│ │ 就寝 1:15 / 起床 7:45（昨夜）       │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ [icon] HRV                       >   │ │
│ │                                     │ │
│ │ 今朝 58ms / 移動前平均 65ms (-7)    │ │
│ │ [!] 移動による一時的な低下          │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ [icon] 睡眠                      >   │ │
│ │                                     │ │
│ │ 昨夜 6h 30m / 深い睡眠 17%          │ │
│ │ ⚠️ 深い睡眠がやや少なめです         │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🏃 活動量                        >   │ │
│ │                                     │ │
│ │ 今日 1,800歩 / 7日平均 8,200歩      │ │
│ │ 💡 移動日は少なくてOK               │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🌡️ 環境                          >   │ │
│ │                                     │ │
│ │ バンコク 32°C / 湿度 78% / AQI 65   │ │
│ └─────────────────────────────────────┘ │
│                                         │
├─────────────────────────────────────────┤
│  [ホーム]  [コンディション]  [設定]     │
└─────────────────────────────────────────┘
```

### 4.4 サーカディアンリズム詳細画面（通常モード）

```
┌─────────────────────────────────────────┐
│ ← サーカディアンリズム                   │
├─────────────────────────────────────────┤
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │         [24時間サークル図]          │ │
│ │                                     │ │
│ │   昨夜の就寝 ●━━━━━━━● 今朝の起床   │ │
│ │      23:15           7:05          │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ 📊 週間トレンド                         │
│                                         │
│ 就寝時刻                                │
│ ┌─────────────────────────────────────┐ │
│ │ 1:00 ─                              │ │
│ │ 0:00 ─      ·                       │ │
│ │23:00 ─ ·  ·    ·  ·  ·  ·          │ │
│ │22:00 ─                              │ │
│ │       月 火 水 木 金 土 日           │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 起床時刻                                │
│ ┌─────────────────────────────────────┐ │
│ │ 9:00 ─            ·                 │ │
│ │ 8:00 ─                  ·           │ │
│ │ 7:00 ─ ·  ·  ·  ·        ·          │ │
│ │ 6:00 ─                              │ │
│ │       月 火 水 木 金 土 日           │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ 📈 リズム安定度                         │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ████████████████░░░░  82/100        │ │
│ │                                     │ │
│ │ 安定 ✓                              │ │
│ │ 就寝・起床時刻が比較的揃っています   │ │
│ │                                     │ │
│ │ 内訳：                              │ │
│ │ • 就寝のばらつき: 32分（小）        │ │
│ │ • 起床のばらつき: 18分（小）        │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ 💡 リズムを整えるヒント                 │
│                                         │
│ • 週末も平日と同じ時間（7:00頃）に      │
│   起きることで、リズムが安定します      │
│                                         │
│ • 朝の光を浴びる（起床後30分以内）      │
│   体内時計のリセットに最も効果的です    │
│                                         │
│ • 就寝2時間前からブルーライトを減らす   │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ 📅 月間データを見る                  >  │
│                                         │
└─────────────────────────────────────────┘
```

### 4.5 サーカディアンリズム詳細画面（トラベルモード）

```
┌─────────────────────────────────────────┐
│ ← サーカディアンリズム                   │
├─────────────────────────────────────────┤
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ⚠️ 調整中                           │ │
│ │ 現地時間と体内時計にずれがあります   │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │         [24時間サークル図]          │ │
│ │                                     │ │
│ │   体内時計（実際の就寝）             │ │
│ │   1:15 ●━━━━━━━━━● 7:45            │ │
│ │                                     │ │
│ │   現地時間での理想                   │ │
│ │  23:00 ○─────────○ 7:00            │ │
│ │                                     │ │
│ │   ずれ: 約2時間15分                 │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ ☀️ 今日のリセットポイント               │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │                                     │ │
│ │  ☀️ 朝の光を浴びる                  │ │
│ │  ⏰ 7:00 - 9:00（現地時間）         │ │
│ │  15分以上、できれば屋外で           │ │
│ │                                     │ │
│ │  ──────────────────────────────     │ │
│ │                                     │ │
│ │  ☕ カフェインを控える               │ │
│ │  ⏰ 14:00 以降                      │ │
│ │  入眠を妨げないために               │ │
│ │                                     │ │
│ │  ──────────────────────────────     │ │
│ │                                     │ │
│ │  🌙 今夜の就寝目標                  │ │
│ │  ⏰ 0:30 頃（昨夜より45分早く）     │ │
│ │  少しずつ理想に近づけましょう       │ │
│ │                                     │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ 📊 週間トレンド                         │
│                                         │
│ （通常モードと同じグラフ）              │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ 📈 リズム安定度                         │
│                                         │
│ （通常モードと同じ表示）                │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ 💡 リズムを整えるヒント                 │
│                                         │
│ • 毎日少しずつ（30分〜1時間）就寝を     │
│   早めて、現地時間に合わせましょう      │
│                                         │
│ • 朝の光を浴びる（7-9時が最適）        │
│   体内時計リセットの最も効果的な方法    │
│                                         │
│ • CT（余白時間）を1日30分確保          │
│   予定を詰めすぎないことが大切です      │
│                                         │
└─────────────────────────────────────────┘
```

### 4.6 環境差分詳細画面（トラベルモード時のみ）

```
┌─────────────────────────────────────────┐
│ ← 環境差分                              │
├─────────────────────────────────────────┤
│                                         │
│ 📍 現在地: バンコク 🇹🇭                 │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ☀️ 32°C  💧 78%  💨 AQI 65          │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ 🏠 拠点（東京）との比較                 │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 気温    +18°C（14°C → 32°C）       │ │
│ │ 湿度    +33%（45% → 78%）          │ │
│ │ 時差    -2h（東京が2時間先）        │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ ↩️ 前にいた場所（ストックホルム）との比較│
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 気温    +30°C（2°C → 32°C）        │ │
│ │ 湿度    +48%（30% → 78%）          │ │
│ │ 時差    +6h（バンコクが6時間先）    │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ 💡 適応のポイント                       │
│                                         │
│ • 急激な気温上昇です。こまめに水分補給  │
│   を心がけてください                    │
│                                         │
│ • 湿度が大幅に上がっています。汗をかき  │
│   やすいので、塩分補給も忘れずに        │
│                                         │
│ • 時差が6時間あります。体内時計の調整  │
│   に3-5日かかる見込みです              │
│                                         │
└─────────────────────────────────────────┘
```

---

## 5. ロケーション管理

### 5.1 3つのロケーション（固定）

| 種類 | 説明 | 設定方法 |
|------|------|---------|
| **Home** | ユーザーの拠点 | ユーザーが手動設定 |
| **Current** | 今いる場所 | 自動検出 |
| **Previous** | 前にいた場所 | 自動検出（7日でクリア） |

### 5.2 リセットルール

```
IF 同じ場所に7日間以上滞在:
    Previous = null（クリア）
    → Current と Home の比較のみ表示

IF Current = Home（拠点に戻った）:
    環境差分セクション = 非表示
    → 通常の環境表示のみ
```

### 5.3 ロジックフロー

```
アプリ起動時:
    1. 現在の位置情報を取得 → new_location
    2. 保存されている Current と比較
    
    IF new_location ≠ Current（都市が変わった）:
        Previous ← Current
        Current ← new_location
        currentLocationSince ← 今日
        保存
    
    ELSE IF 同じ都市に7日以上:
        Previous ← null（クリア）
        保存
    
    ELSE:
        何もしない
```

### 5.4 データ構造

```swift
struct LocationHistory: Codable {
    /// ホームロケーション（ユーザー設定）
    var home: LocationInfo?
    
    /// 現在地
    var current: LocationInfo?
    
    /// 前にいた場所（7日でクリア）
    var previous: LocationInfo?
    
    /// 現在地に来た日（7日カウント用）
    var currentLocationSince: Date?
}

struct LocationInfo: Codable {
    let city: String           // "バンコク"
    let country: String        // "タイ"
    let countryCode: String    // "TH"
    let timezone: String       // "Asia/Bangkok"
    let timezoneOffset: Int    // +7
    let latitude: Double
    let longitude: Double
}
```

### 5.5 環境差分の表示ルール

| 状態 | 表示内容 |
|------|---------|
| **Current ≠ Home かつ Previous あり** | Home との比較 + Previous との比較 |
| **Current ≠ Home かつ Previous なし** | Home との比較のみ |
| **Current = Home** | 環境差分セクション非表示 |

### 5.6 オンボーディングでの拠点設定

画面4（職業・生活習慣）に追加：

```
┌─────────────────────────────────────────┐
│ ← 戻る                           4/7    │
├─────────────────────────────────────────┤
│                                         │
│ もう少し教えてください                  │
│                                         │
│ あなたの生活スタイルに合わせた          │
│ アドバイスができます（任意）            │
│                                         │
│ ─────────────────────────────────────── │
│                                         │
│ 職業カテゴリー                          │
│ ┌─────────────────────────────────────┐ │
│ │ IT・エンジニア                    ▼ │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 生活リズム                              │
│ ┌─────────────────────────────────────┐ │
│ │ 朝型                              ▼ │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 運動習慣                                │
│ ┌─────────────────────────────────────┐ │
│ │ 週3-4回                           ▼ │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 拠点（ホームロケーション）              │
│ ┌─────────────────────────────────────┐ │
│ │ 🔍 都市名を入力                     │ │
│ └─────────────────────────────────────┘ │
│ サーカディアンリズムの基準になります    │
│                                         │
│        [スキップ]     [次へ]            │
│                                         │
└─────────────────────────────────────────┘
```

---

## 6. AIプロンプト設計

### 6.1 プロンプト構造の概要

既存のLayer 1〜3構造を維持し、トラベルモード時のみ追加コンテキストを挿入：

```
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: システムプロンプト（静的・キャッシュ対象）          │
│ - 役割定義、禁止事項、トーン、出力形式                      │
│ - TTL: 1時間                                               │
├─────────────────────────────────────────────────────────────┤
│ Layer 2: 例文（関心ごとに応じて動的選択）                   │
│ - 良好版・疲労版の例文                                     │
│ - TTL: 5分                                                 │
├─────────────────────────────────────────────────────────────┤
│ Layer 2.5: トラベルモードコンテキスト（トラベルモード時のみ）│ ← 新規
│ - サーカディアンリズム調整の優先指示                        │
│ - 光/CT/カフェインの具体的提案指示                         │
├─────────────────────────────────────────────────────────────┤
│ Layer 3: ユーザーデータ（動的）                             │
│ - プロフィール、HealthKit、気象データ                      │
│ - トラベルモード時: ロケーション情報、環境差分を追加        │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 トラベルモード用追加コンテキスト（Layer 2.5）

```xml
<travel_mode_context>
ユーザーは現在「トラベルモード」をONにしています。
移動が多い時期、または時差のある環境にいる可能性が高い状態です。

【優先すべきアドバイスの方向性】

1. サーカディアンリズム調整を最優先
   - 睡眠タイミングの「ずれ」を明確に指摘する
   - 普段の就寝・起床パターンとの比較を行う
   - 体内時計リセットの具体的な方法を提案する

2. 光のタイミング（最重要）
   - 朝の光を浴びるべき時間帯を具体的に提案（例：7-9時）
   - 夕方以降のブルーライト回避を推奨
   - 「光が体内時計をリセットする」という根拠を簡潔に説明

3. CT（コントロールタイム）= 余白時間
   - 1日の中に30分〜1時間の「予定を入れない時間」を提案
   - 深呼吸、水分補給、短い仮眠を推奨
   - 「予定を詰めすぎない」ことの重要性を伝える

4. カフェイン摂取のタイミング
   - 14時以降のカフェイン摂取を控えるよう提案
   - 入眠への影響を根拠として説明

5. 環境適応
   - 気温差、湿度差、気圧変化への言及
   - 脱水リスクへの注意喚起
   - 大気質が悪い場合の対応

6. トーンの調整
   - 「適応期間である」ことを前提にする
   - 完璧を求めず「最低限これだけやればOK」という守りのアドバイス
   - 「あと数日で慣れる」という安心感を与える
   - 焦らせない、責めない

7. 今日のトライの選定基準
   - 場所を選ばない、どこでもできる提案を優先
   - 道具が不要、または最小限で済むもの
   - リズム調整に効果的なもの（呼吸法、光浴、仮眠など）

【使用してよい表現例】
- 「体内時計がまだ調整中ですね」
- 「あと2-3日で体が慣れてきます」
- 「焦らず、余白を大切に」
- 「移動による一時的な変化です」
- 「今は回復を優先しましょう」

【避けるべき表現】
- 「調子が悪いですね」（→「調整中」と表現）
- 「睡眠が足りていません」（→「リズムがずれています」と表現）
- 過度に心配させる表現
</travel_mode_context>
```

### 6.3 トラベルモード時のユーザーデータ（Layer 3 追加項目）

```xml
<travel_context>
  <mode>travel</mode>
  
  <home_location>
    <city>東京</city>
    <country>日本</country>
    <timezone>UTC+9</timezone>
    <current_weather>
      <temperature>14</temperature>
      <humidity>45</humidity>
    </current_weather>
  </home_location>
  
  <current_location>
    <city>バンコク</city>
    <country>タイ</country>
    <timezone>UTC+7</timezone>
    <local_time>07:30</local_time>
    <days_here>3</days_here>
    <current_weather>
      <temperature>32</temperature>
      <humidity>78</humidity>
      <aqi>65</aqi>
    </current_weather>
  </current_location>
  
  <!-- Previous は存在する場合のみ含める -->
  <previous_location>
    <city>ストックホルム</city>
    <country>スウェーデン</country>
    <timezone>UTC+1</timezone>
  </previous_location>
  
  <environment_delta>
    <from_home>
      <temperature_diff>+18</temperature_diff>
      <humidity_diff>+33</humidity_diff>
      <time_diff>-2h</time_diff>
    </from_home>
    <!-- Previous がある場合のみ含める -->
    <from_previous>
      <temperature_diff>+30</temperature_diff>
      <humidity_diff>+48</humidity_diff>
      <time_diff>+6h</time_diff>
    </from_previous>
  </environment_delta>
  
  <rhythm_status>
    <usual_bedtime>23:00</usual_bedtime>
    <last_night_bedtime>01:15</last_night_bedtime>
    <bedtime_shift>+2h15m</bedtime_shift>
    <usual_waketime>07:00</usual_waketime>
    <last_night_waketime>07:45</last_night_waketime>
    <waketime_shift>+45m</waketime_shift>
  </rhythm_status>
</travel_context>
```

### 6.4 トラベルモード時のJSON出力追加フィールド

```json
{
  "greeting": "マサさん、おはようございます",
  
  "condition": {
    "summary": "昨夜の就寝は現地1:15。普段のリズム（23時頃）から約2時間ずれています。HRVも58msと移動前より低下中。体内時計がまだ調整中ですね。",
    "detail": "昨夜の就寝は現地時間で1:15でしたね。あなたの普段の就寝時間（23時頃）から約2時間15分ずれています。\n\n今朝のHRVは58msと、移動前の平均65msより7ms低下しています。これは移動による一時的な変化で、体が新しい環境に適応しようとしている証拠です。\n\nバンコクは気温32°C、湿度78%と、東京と比べて気温差+18°C、湿度差+33%あります。体への負担が大きい環境変化ですので、無理せず過ごしましょう。"
  },
  
  "rhythm_adjustment": {
    "current_shift": "約2時間15分のずれ",
    "light_timing": {
      "recommendation": "7-9時に15分以上、外の光を浴びてください",
      "reason": "体内時計リセットの最も効果的な方法です"
    },
    "caffeine_cutoff": {
      "time": "14:00",
      "reason": "今夜の入眠を妨げないためです"
    },
    "ct_recommendation": {
      "time_slot": "13-15時",
      "duration": "30分",
      "activities": ["深呼吸", "水分補給", "短い仮眠"]
    },
    "bedtime_goal": {
      "time": "0:30",
      "note": "昨夜より45分早く"
    }
  },
  
  "action_suggestions": [
    {
      "icon": "outdoor",
      "title": "朝の光を浴びる",
      "detail": "7-9時の間に15分以上、外の光を浴びてください。サングラスは外して。体内時計リセットに最も効果的です。"
    },
    {
      "icon": "hydration",
      "title": "こまめな水分補給",
      "detail": "気温差+18°C、湿度差+33%の環境です。普段より1.5倍の水分を意識して摂りましょう。"
    },
    {
      "icon": "rest",
      "title": "CT（余白時間）を確保",
      "detail": "13-15時の間に30分、予定を入れない時間を作ってください。深呼吸や短い仮眠で、体をリセットしましょう。"
    },
    {
      "icon": "sleep",
      "title": "カフェインは14時まで",
      "detail": "今夜の入眠をスムーズにするため、14時以降はカフェインを控えてください。"
    }
  ],
  
  "closing_message": "あと2-3日で体が慣れてきます。焦らず、余白を大切にお過ごしください。",
  
  "daily_try": {
    "title": "4-7-8呼吸法で眠りを整える",
    "summary": "今夜、就寝前に5分だけ。移動で高ぶった神経を鎮めます。",
    "detail": "今夜、就寝前に5分だけ「4-7-8呼吸法」を試してみてください。\n\n4秒かけて鼻から息を吸い、7秒息を止め、8秒かけて口から吐きます。これを4-8回繰り返します。\n\nこの呼吸法は副交感神経を活性化し、移動で高ぶった交感神経を鎮める効果があります。時差調整中の今、特に効果的です。\n\n道具も場所も選びません。ホテルのベッドで、寝る直前に試してみてください。"
  },
  
  "weekly_try": null,
  
  "adaptation_note": "あと2-3日で体が慣れてきます。焦らず、余白を大切に。"
}
```

### 6.5 通常モードとトラベルモードの比較表

| 項目 | 通常モード | トラベルモード |
|------|-----------|---------------|
| **greeting** | 変更なし | 変更なし |
| **condition.summary** | コンディション全般 | リズムのずれ + 環境差分に言及 |
| **condition.detail** | データに基づく状態説明 | ずれの具体的な数値 + 適応期間の説明 |
| **rhythm_adjustment** | なし | **追加**: 光/カフェイン/CT/就寝目標 |
| **action_suggestions** | 関心ごとタグベース | リズム調整 + 環境適応中心 |
| **closing_message** | 「良い一日を」系 | 「焦らず」「余白を大切に」系 |
| **daily_try** | 関心ごとタグ 70-80% | 場所を選ばない + リズム調整系 |
| **weekly_try** | 月曜のみ生成 | 月曜のみ生成（内容は変化） |
| **adaptation_note** | なし | **追加**: 適応の目安 |

---

## 7. データ算出ロジック

### 7.1 算出方法の分類

| データ項目 | 算出方法 | AIに依頼するか |
|-----------|---------|---------------|
| 就寝・起床時刻 | HealthKitから取得 | No（生データ） |
| 平均就寝・起床 | 過去7日の平均を計算 | No（計算） |
| ずれ時間 | 理想時刻 - 実際時刻 | No（計算） |
| リズム安定度スコア | 標準偏差ベースで計算 | No（計算） |
| リズムを整えるヒント | 固定テンプレート + 条件分岐 | No（テンプレート） |
| 今日のリセットポイント | 固定ロジック + 現地時間 | No（ロジック） |
| 環境差分 | 2地点の気象データの差分計算 | No（計算） |
| メインアドバイス文章 | — | **Yes**（パーソナライズ必要） |
| 今日のトライ | — | **Yes**（多様性必要） |

### 7.2 リズム安定度スコアの算出

```
安定度スコア = 100 - (就寝時刻の標準偏差 × 係数A) - (起床時刻の標準偏差 × 係数B)

係数A = 2.5（就寝の方が重要）
係数B = 2.0

計算例：
- 就寝時刻の標準偏差: 30分（0.5時間）
- 起床時刻の標準偏差: 20分（0.33時間）
- スコア = 100 - (0.5 × 2.5 × 10) - (0.33 × 2.0 × 10)
         = 100 - 12.5 - 6.6
         = 80.9 ≒ 81

表示ランク：
- 90-100: 非常に安定 ✓✓
- 75-89:  安定 ✓
- 60-74:  やや不安定 △
- 0-59:   不安定 ▽
```

### 7.3 リズムを整えるヒント（条件分岐ロジック）

```
条件分岐ルール:

IF 就寝時刻が遅い傾向（平均 > 24:00）:
  → 「就寝を毎日15-30分ずつ早めてみましょう」
  → 「21時以降はブルーライトを減らしましょう」

IF 起床時刻のばらつきが大きい（標準偏差 > 1時間）:
  → 「週末も平日と同じ時間に起きることが大切です」
  → 「目覚ましを固定時刻にセットしましょう」

IF 就寝時刻のばらつきが大きい（標準偏差 > 1時間）:
  → 「就寝前のルーティンを作りましょう」
  → 「寝る1時間前から同じ行動を繰り返すと、体が眠りの準備を始めます」

IF リズムが安定している（スコア > 85）:
  → 「素晴らしいリズムです。この調子を維持しましょう」
  → 「朝の光を浴びる習慣を続けてください」

IF トラベルモードON:
  → 「毎日少しずつ（30分〜1時間）就寝を早めて、現地時間に合わせましょう」
  → 「朝の光を浴びる（7-9時が最適）」
  → 「CT（余白時間）を1日30分確保」

DEFAULT（常に表示）:
  → 「朝の光を浴びる（起床後30分以内）」
  → 「就寝2時間前からブルーライトを減らす」
```

### 7.4 今日のリセットポイント（トラベルモード時）

```
算出ロジック:

■ 朝の光を浴びる最適時間
  = 現地の日の出時刻 〜 日の出 + 3時間
  = 例: 日の出 6:30 → 6:30 - 9:30 が最適
  = 表示: 「7:00 - 9:00」（キリの良い時間に丸める）

■ カフェインカットオフ
  = 固定で「14:00」
  = 理由: 就寝6-8時間前にカフェインを控えるのが一般的推奨

■ 今夜の就寝目標
  = 昨夜の就寝時刻 - 30分〜1時間
  = 例: 昨夜 1:15 → 今夜の目標 0:15〜0:45
  = 段階的に理想（23:00）に近づける
  = 1日に1時間以上のジャンプは避ける
```

### 7.5 環境差分の算出

```
■ 気温差
  = Current の気温 - 比較対象（Home or Previous）の気温
  = 表示: 「+18°C（14°C → 32°C）」

■ 湿度差
  = Current の湿度 - 比較対象の湿度
  = 表示: 「+33%（45% → 78%）」

■ 時差
  = Current のタイムゾーンオフセット - 比較対象のオフセット
  = 表示: 「-2h（東京が2時間先）」or「+6h（バンコクが6時間先）」

■ 表示優先度
  1. Home との比較（常に表示）
  2. Previous との比較（Previous が存在する場合のみ）
```

---

## 8. 実装フェーズ

### 8.1 推奨フェーズ構成

既存のPhase 1-14（MVP）完了後に実装：

```
Phase 1-14: 既存MVP（変更なし）
    ↓ すべて完了後
    
Phase 15: コンディション画面の追加
    - 新規タブ「コンディション」
    - コンディショントップ画面
    - サーカディアンリズム詳細画面
    - HRV詳細画面
    - 睡眠詳細画面
    - 活動量詳細画面
    - 環境詳細画面
    - リズム安定度スコアの算出ロジック
    - ヒントの条件分岐ロジック
    
Phase 16: トラベルモード
    - 設定画面にトグル追加
    - ホーム画面ヘッダーにトグル追加
    - オンボーディングに拠点設定を追加
    - ロケーション管理（Home/Current/Previous）
    - 環境差分詳細画面
    - AIプロンプトの分岐（トラベルモード用コンテキスト）
    - アドバイス内容の変化
    - リセットポイントの算出ロジック
```

### 8.2 Phase 15: コンディション画面の詳細

**スコープ**:
- タブバーを2タブ→3タブに変更
- コンディショントップ画面
- 各詳細画面（リズム、HRV、睡眠、活動、環境）
- リズム安定度スコアの算出
- ヒントの条件分岐ロジック
- 週間トレンドグラフ

**成果物**:
- コンディション画面が動作する
- 各指標の詳細が確認できる
- リズム安定度スコアが表示される

**依存関係**:
- Phase 1-14（既存MVP）の完了

### 8.3 Phase 16: トラベルモードの詳細

**スコープ**:
- トラベルモードのON/OFFトグル
- ロケーション管理（UserDefaults保存）
- 環境差分の算出・表示
- AIプロンプトへのトラベルコンテキスト追加
- アドバイス内容の変化
- 今日のリセットポイントの算出
- オンボーディングへの拠点設定追加

**成果物**:
- トラベルモードをON/OFFできる
- ON時にアドバイスがサーカディアンリズム調整中心に変化
- 環境差分が表示される
- リセットポイントが表示される

**依存関係**:
- Phase 15（コンディション画面）の完了

### 8.4 既存フェーズへの影響

| 既存フェーズ | 影響 | 対応 |
|-------------|------|------|
| Phase 2（ホーム画面基本） | タブバー変更 | Phase 15で対応 |
| Phase 6（設定画面） | トラベルモード追加 | Phase 16で対応 |
| Phase 9（Claude API統合） | プロンプト分岐追加 | Phase 16で対応 |
| その他 | 影響なし | — |

---

## 付録

### A. 用語集

| 用語 | 説明 |
|------|------|
| **サーカディアンリズム** | 約24時間周期で変動する生理現象。体内時計。 |
| **HRV（Heart Rate Variability）** | 心拍変動。自律神経の状態や回復度を示す。 |
| **CT（Control Time）** | 余白時間。予定を入れない休息の時間。 |
| **リズム安定度スコア** | 就寝・起床時刻のばらつきから算出するスコア。 |
| **Home Location** | ユーザーの拠点。サーカディアンリズムの基準。 |
| **環境差分** | 現在地と拠点（または前にいた場所）との気象・時差の差。 |

### B. 参考文献・インスピレーション

- サーカディアンリズムと光の関係
- CT（コントロールタイム）の概念
- 時差ボケ対策としてのカフェイン管理
- 旅先での休息計画の重要性

### C. 改訂履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2025-12-11 | 初版作成 |

---

**以上、Tempo AI トラベルモード & コンディション画面 設計仕様書 v1.0**
